<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="精神小伙" href="https://junwide.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="精神小伙" href="https://junwide.github.io/atom.xml"><link rel="alternate" type="application/json" title="精神小伙" href="https://junwide.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Linux,Kernel"><link rel="canonical" href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic%20II/"><title>Kernel Module — Char Device Basic II - Linux基础 | Brain Home = 精神小伙 = Tech.&Mem.</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Kernel Module — Char Device Basic II</h1><div class="meta"><span class="item" title="创建时间：2021-04-22 15:25:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-04-22T15:25:00+08:00">2021-04-22</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>8.3k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>15 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Brain Home</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104501.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104136.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104617.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104415.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104528.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104554.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/linux-basic/" itemprop="item" rel="index" title="分类于 Linux基础"><span itemprop="name">Linux基础</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic%20II/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Junwide Xiao"><meta itemprop="description" content="Tech.&Mem., 生活与技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="精神小伙"></span><div class="body md" itemprop="articleBody"><h1 id="kernel-module-char-device-basic-ii"><a class="anchor" href="#kernel-module-char-device-basic-ii">#</a> Kernel Module — Char Device Basic II</h1><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210420235101.png" alt="image-20210420235054817"></p><p><strong>Goal</strong></p><p>上一篇介绍了一般字符驱动的开发逻辑，而这一篇主要是讲一般的字符型驱动以外的，其他类字符型驱动设备的开发逻辑，以及内核里非常巧妙的内核无锁环形缓存区 KFIFO 的使用和具体的实现逻辑。</p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_0" disabled><label for="cbx_0">Misc 驱动开发逻辑</label></li><li class="task-list-item"><input type="checkbox" id="cbx_1" disabled><label for="cbx_1">Misc 驱动的适用范围</label></li><li class="task-list-item"><input type="checkbox" id="cbx_2" disabled><label for="cbx_2">KFIFO 的使用</label></li></ul><p><strong>Preconditions</strong></p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_3" checked disabled><label for="cbx_3">了解 Make</label></li><li class="task-list-item"><input type="checkbox" id="cbx_4" checked disabled><label for="cbx_4">了解 C</label></li><li class="task-list-item"><input type="checkbox" id="cbx_5" checked disabled><label for="cbx_5">了解 Bash 语法</label></li><li class="task-list-item"><input type="checkbox" id="cbx_6" checked disabled><label for="cbx_6">了解上一篇的内容</label></li></ul><h2 id="misc-char-device"><a class="anchor" href="#misc-char-device">#</a> MISC Char Device</h2><p>Miscellaneous Devices：其他设备，也就是指没有在 Linux Kernel Document 中写明的驱动类型，都可以用 Misc 机制来注册和管理驱动。因为有时人们需要编写 “小型” 设备驱动程序，以支持自定义的 hack（硬件或软件），而 Misc 的好处就是简化了我们对 Module 开发的步骤，从注册到创建设备节点都一站式完成，使得整个流程非常顺滑。但是 Misc 驱动也有自己缺陷，就是无法注册多个设备节点</p><ul><li><p><strong>MISC 机制的内容</strong></p><ul><li><p><code>miscdevice</code> ：管理着所有信息</p></li><li><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">miscdevice</span>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">int</span> minor<span class="token punctuation">;</span>                     <span class="token comment">// 标志为动态分配</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>             <span class="token comment">// 模块名</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">;</span>  <span class="token comment">// 对应我们的函数集</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>this_device<span class="token punctuation">;</span>  <span class="token comment">// 这是注册完返回的设备</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nodename<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token class-name">umode_t</span> mode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p>注册和注销</p><ul><li><code>int misc_register(struct miscdevice *misc)</code> ：注册一个 misc 设备</li><li><code>void misc_deregister(struct miscdevice *misc)</code> ：注销一个 misc 设备</li></ul></li><li><p>赋值：</p><ul><li><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">miscdevice</span> mydemo_device_misc_d <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">.</span>minor <span class="token operator">=</span> MISC_DYNAMIC_MINOR<span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">.</span>name <span class="token operator">=</span> DEMO_NAME<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">.</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>demo_fops</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul></li></ul></li></ul><h2 id="kernel-data-struct"><a class="anchor" href="#kernel-data-struct">#</a> Kernel Data Struct</h2><ul><li><strong>KFIFO</strong><ul><li>内核无锁环形缓冲区</li><li>原理：实现一个读指针（指向可读区域），一个写指针（指向可写区域）在一个环形的缓冲区中操作</li><li>实现：能够在一个读进程和一个写进程并发的场景下，无须加锁来保证数据的安全，当然还是提供了加锁的操作的（例如加了自旋锁的 in 和 out）</li><li>操作：<ul><li>注册：<ul><li><code>DEFINE_KFIFO(fifo, type, size)</code> ：声明和初始化一个 FIFO</li><li><code>kfifo_init(fifo, buffer, size)</code> ：声明和初始化一个 FIFO</li><li><code>kfifo_alloc(fifo, size, gfp_mask)</code> ：请求一个 FIFO 的 buffer</li></ul></li><li>操作：<ul><li><code>kfifo_is_full</code> ：是否满</li><li><code>kfifo_is_empty</code> : 是否空</li><li><code>kfifo_len</code> ：获得 fifo 已经使用的元素个数</li><li><code>kfifo_avail</code> ：获得 fifo 没有使用的个数</li><li><code>kfifo_size</code> ：获得 fifo 的大小</li><li><code>kfifo_reset</code> ：重置 fifo 的内容</li></ul></li><li>数据迁移：<ul><li><code>kfifo_from_user(fifo, from, len, copied)</code><ul><li><code>fifo</code> ：缓存区的对象</li><li><code>from</code> ：读取的地方</li><li><code>len</code> ：读取的数量</li><li><code>copied</code> ：读取成功的数量，会赋值到这个变量上</li></ul></li><li><code>kfifo_to_user(fifo, to, len, copied)</code><ul><li><code>fifo</code> ：缓存区的对象</li><li><code>to</code> ：存放的地方</li><li><code>len</code> ：读取的数量</li><li><code>copied</code> ：读取成功的数量，会赋值到这个变量上</li></ul></li></ul></li><li>释放： <code>kfifo_free(fifo)</code> 释放一个 fifo 空间</li></ul></li></ul></li><li><strong>I/O 非阻塞</strong><ul><li>非阻塞：就是不等待，直接操作，要么操作成功，要么返回错误码</li><li>阻塞：就是会等待，等待条件满足后唤醒</li><li>FLAG：<strong>O_NONBLOCK</strong></li></ul></li></ul><h2 id="source-code"><a class="anchor" href="#source-code">#</a> Source Code</h2><figure class="highlight c"><figcaption data-lang="c"><span>demo.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/miscdevice.h></span> <span class="token comment">//misc 机制的头文件</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span>  </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kfifo.h></span>    <span class="token comment">// 内核无环缓冲区</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEMO_NAME</span> <span class="token string">"kfifodriver"</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span> mydemo_device<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">DEFINE_KFIFO</span><span class="token punctuation">(</span>demo_fifo<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span> inode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 我们将驱动做成一个设备节点，所以可以用 inode 结构来访问，驱动信息</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_rdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_rdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"%s: Major Num: %d , Minor Num: %d"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span>major<span class="token punctuation">,</span>minor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span> inode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//loff_t 表示当前读写位置的 offset  </span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">demo_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> buf_count<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="26"></td><td><pre>                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#123;</span>    </pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">int</span> readed_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kfifo_is_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>demo_fifo<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">kfifo_to_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>demo_fifo<span class="token punctuation">,</span>buf<span class="token punctuation">,</span> buf_count<span class="token punctuation">,</span><span class="token operator">&amp;</span>readed_<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>       <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"%s readed = %d, pos = %lld \n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span>readed_<span class="token punctuation">,</span><span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">return</span> readed_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">demo_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> buf_count<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="42"></td><td><pre>                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">int</span> writed_ <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kfifo_is_full</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>demo_fifo<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">kfifo_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>demo_fifo<span class="token punctuation">,</span>buf<span class="token punctuation">,</span> buf_count<span class="token punctuation">,</span><span class="token operator">&amp;</span>writed_<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回没有拷贝成功的字节数</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">if</span>  <span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"%s writed = %d, pos = %lld \n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span>writed_<span class="token punctuation">,</span><span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">return</span> writed_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> demo_fops <span class="token operator">=</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">.</span>open  <span class="token operator">=</span> demo_open<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">.</span>release <span class="token operator">=</span> demo_release<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">.</span>read <span class="token operator">=</span> demo_read<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">.</span>write <span class="token operator">=</span> demo_write</pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">miscdevice</span> mydemo_device_misc_d <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">.</span>minor <span class="token operator">=</span> MISC_DYNAMIC_MINOR<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">.</span>name <span class="token operator">=</span> DEMO_NAME<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">.</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>demo_fops</pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">demo_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mydemo_device_misc_d<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"Faild in register misc device"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    mydemo_device <span class="token operator">=</span> mydemo_device_misc_d<span class="token punctuation">.</span>this_device<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"success register misc device: %s\n"</span><span class="token punctuation">,</span>DEMO_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span>  __exit <span class="token function">demo_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"remove Device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token function">misc_deregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mydemo_device_misc_d<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token function">module_init</span><span class="token punctuation">(</span>demo_init<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token function">module_exit</span><span class="token punctuation">(</span>demo_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment">// 模块可选信息</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 许可证声明</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"junwide"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 作者声明</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"This module is a char device"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块描述</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token function">MODULE_VERSION</span><span class="token punctuation">(</span><span class="token string">"V1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块别名</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token function">MODULE_ALIAS</span><span class="token punctuation">(</span><span class="token string">"Char Modules"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块别名</span></pre></td></tr></table></figure><h2 id="build-code"><a class="anchor" href="#build-code">#</a> Build Code</h2><p><strong>Makefile</strong></p><p>和 Single Module 的 Makefile 一样，不在赘述</p><h2 id="test"><a class="anchor" href="#test">#</a> <strong>Test</strong></h2><figure class="highlight c"><figcaption data-lang="c"><span>test.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEMO_DEV_NAME</span> <span class="token string">"/dev/kfifodriver"</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">int</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">char</span> message<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"we come from china"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>r_buffer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">size_t</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     </pre></td></tr><tr><td data-num="16"></td><td><pre>	fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>DEMO_DEV_NAME<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open device %s failded\n"</span><span class="token punctuation">,</span> DEMO_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    r_buffer <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>r_buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>r_buffer<span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read %d bytes\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Context: %s\n"</span><span class="token punctuation">,</span>r_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>message<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> ret <span class="token operator">!=</span> len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can not write on device %d ret: %d \n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>message<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> ret <span class="token operator">!=</span> len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can not write on device %d ret: %d \n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>r_buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>r_buffer<span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read %d bytes\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Context: %s\n"</span><span class="token punctuation">,</span>r_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>编译和安装</strong></p><figure class="highlight bash"><figcaption data-lang="bash"><span>Commad命令行</span></figcaption><table><tr><td data-num="1"></td><td><pre>$ gcc test.c -o <span class="token builtin class-name">test</span> --static</pre></td></tr><tr><td data-num="2"></td><td><pre>$ <span class="token function">make</span> <span class="token comment">#编译</span></pre></td></tr><tr><td data-num="3"></td><td><pre>$ <span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span> <span class="token comment"># 安装并启动</span></pre></td></tr><tr><td data-num="4"></td><td><pre>$ <span class="token function">sudo</span> ./test</pre></td></tr></table></figure><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210227231316.png" alt="image-20200925200044281"></p><p>已经 KFIFO 满了，却没阻塞，再次写入引发错误</p><h2 id="summary"><a class="anchor" href="#summary">#</a> Summary</h2><p>这一篇主要内容是实现一个简单的 Misc 的驱动，同时能够调用 KFIFO 进行数据在用户态和内核态的传输。具体的 Misc 在内核实现的例子，可以参考内核中硬件看门狗的驱动实现。后面的拓展内容主要是介绍 KFIFO 的原理和实现的。</p><h2 id="more-about-kfifo"><a class="anchor" href="#more-about-kfifo">#</a> More About KFIFO</h2><p>KFIFO 全称为 Kernel First In First Out ，是内核无锁环形缓冲区，作为内核非常重要的数据结构，它有以下几个非常重要的特点，而这几个特点也将作为我们的切入点来了解这个设计巧妙的数据结构。无锁循环队列的应用范围很广泛，例如：在低频单片机中，串口接收数据（中断模式）可以将 ISR 分为 top half 和 bottom half，top half 负责接收数据并将数据存放到循环队列中，而 bottom half 负责从队列中取出数据并处理数据。用类似以上的实现，可以减少一个锁，从而实现更高的并发度和资源利用率。</p><ul><li><p><strong>高效编程理念</strong></p></li><li><p><strong>巧用环形缓冲</strong></p></li><li><p><strong>并行无锁技术</strong></p></li></ul><figure class="highlight c"><figcaption data-lang="c"><span>KFIFO数据结构</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">__kfifo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	in<span class="token punctuation">;</span> <span class="token comment">/*  (in &amp;= mask) 就是缓存区的入队索引 */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	out<span class="token punctuation">;</span> <span class="token comment">/* (out &amp;= mask) 缓存区的出队索引 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	mask<span class="token punctuation">;</span> <span class="token comment">/* 获取偏移的掩码 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	esize<span class="token punctuation">;</span> <span class="token comment">/* 每个元素所占的字节数 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">void</span>		<span class="token operator">*</span>data<span class="token punctuation">;</span> <span class="token comment">/* 指针：指向存放缓存的数据 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="高效编程理念"><a class="anchor" href="#高效编程理念">#</a> 高效编程理念</h3><p>让我们先来看一代码，主要观察高亮的部分的写法。</p><figure class="highlight c"><figcaption data-lang="c"><span>KFIFO初始化</span><span class="exturl" data-url="aHR0cHM6Ly9lbGl4aXIuYm9vdGxpbi5jb20vbGludXgvdjUuMTItcmM4L3NvdXJjZS9saWIva2ZpZm8uYyNMMjQ=">参考链接</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">__kfifo_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__kfifo</span> <span class="token operator">*</span>fifo<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span><span class="token class-name">size_t</span> esize<span class="token punctuation">,</span> <span class="token class-name">gfp_t</span> gfp_mask<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	 * round up to the next power of 2, since our 'let the indices</pre></td></tr><tr><td data-num="5"></td><td><pre>	 * wrap' technique works only in this case.</pre></td></tr><tr><td data-num="6"></td><td><pre>	 */</pre></td></tr><tr class="marked"><td data-num="7"></td><td><pre>	size <span class="token operator">=</span> <span class="token function">roundup_pow_of_two</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>	fifo<span class="token operator">-></span>in <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	fifo<span class="token operator">-></span>out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	fifo<span class="token operator">-></span>esize <span class="token operator">=</span> esize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		fifo<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		fifo<span class="token operator">-></span>mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>	fifo<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">kmalloc_array</span><span class="token punctuation">(</span>esize<span class="token punctuation">,</span> size<span class="token punctuation">,</span> gfp_mask<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fifo<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		fifo<span class="token operator">-></span>mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	fifo<span class="token operator">-></span>mask <span class="token operator">=</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里使用了一个 <code>roundup_pow_of_two()</code> 的函数来完成大小的确定，这个函数主要的是作用有：</p><ul><li>找出与用户给定 <code>size</code> 最近的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">2^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.664392em;vertical-align:0"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span> 的数（例如: Size (用户) 7 , 找出的数是 8 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">2^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8141079999999999em;vertical-align:0"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span>)）</li><li>尽可能快的完成上一步的操作</li></ul><figure class="highlight c"><figcaption data-lang="c"><span>找数</span><span class="exturl" data-url="aHR0cHM6Ly9lbGl4aXIuYm9vdGxpbi5jb20vbGludXgvdjUuMTItcmM4L3NvdXJjZS9pbmNsdWRlL2xpbnV4L2xvZzIuaCNMMTc0">参考链接</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">roundup_pow_of_two</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">)</span>			</span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token expression"><span class="token punctuation">(</span>						</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token expression"><span class="token function">__builtin_constant_p</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>		</span><span class="token punctuation">\</span></pre></td></tr><tr class="marked"><td data-num="4"></td><td><pre>		<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span>		</span><span class="token punctuation">\</span></pre></td></tr><tr class="marked"><td data-num="5"></td><td><pre>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">ilog2</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>				   <span class="token expression"><span class="token punctuation">)</span> <span class="token operator">:</span>		</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token expression"><span class="token function">__roundup_pow_of_two</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>			</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token expression"><span class="token punctuation">)</span></span></pre></td></tr></table></figure><p>这里用到了两个方法来实现了高效的操作：</p><ol><li><code>ilog2()</code> 函数调用的是汇编的 <code>bsr</code> 用来找到 <code>n-1</code> 的最高有效的 1 的位置</li><li>找到最高有效的 1 的位置后使用<strong>位移操作</strong>直接获取到有效的大小（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">2^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.664392em;vertical-align:0"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>）</li></ol><blockquote><p><code>bsr</code> ：bsr %0 %1 x86 汇编的一个指令，用于扫描一个 %1 中数的最高有效的 1 的位置索引，并存到 %0</p><p>例如：bsr % a #8 那么 a 中就会存 3</p></blockquote><h3 id="巧用环形缓冲"><a class="anchor" href="#巧用环形缓冲">#</a> 巧用环形缓冲</h3><p>采用环形缓冲区的好处为，<strong>当一个数据元素被用掉后，其余数据元素不需要移动其存储位置</strong>，从而减少拷贝提高效率。</p><figure class="highlight c"><figcaption data-lang="c"><span>入队</span><span class="exturl" data-url="aHR0cHM6Ly9lbGl4aXIuYm9vdGxpbi5jb20vbGludXgvdjUuMTItcmM4L3NvdXJjZS9saWIva2ZpZm8uYyNMODk=">参考链接</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">kfifo_copy_in</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__kfifo</span> <span class="token operator">*</span>fifo<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> off<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> fifo<span class="token operator">-></span>mask <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> esize <span class="token operator">=</span> fifo<span class="token operator">-></span>esize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> l<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="8"></td><td><pre>	off <span class="token operator">&amp;=</span> fifo<span class="token operator">-></span>mask<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>esize <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 这一部分主要是处理数据占大小的，这会影响指针寻址</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		off <span class="token operator">*=</span> esize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		size <span class="token operator">*=</span> esize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		len <span class="token operator">*=</span> esize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr class="marked"><td data-num="14"></td><td><pre>	l <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> size <span class="token operator">-</span> off<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="15"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="16"></td><td><pre>	<span class="token function">memcpy</span><span class="token punctuation">(</span>fifo<span class="token operator">-></span>data <span class="token operator">+</span> off<span class="token punctuation">,</span> src<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="17"></td><td><pre>	<span class="token function">memcpy</span><span class="token punctuation">(</span>fifo<span class="token operator">-></span>data<span class="token punctuation">,</span> src <span class="token operator">+</span> l<span class="token punctuation">,</span> len <span class="token operator">-</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	 * make sure that the data in the fifo is up to date before</pre></td></tr><tr><td data-num="20"></td><td><pre>	 * incrementing the fifo->in index counter</pre></td></tr><tr><td data-num="21"></td><td><pre>	 */</pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token function">smp_wmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">__kfifo_in</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__kfifo</span> <span class="token operator">*</span>fifo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> l<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="30"></td><td><pre>	l <span class="token operator">=</span> <span class="token function">kfifo_unused</span><span class="token punctuation">(</span>fifo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">></span> l<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		len <span class="token operator">=</span> l<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token function">kfifo_copy_in</span><span class="token punctuation">(</span>fifo<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fifo<span class="token operator">-></span>in<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="35"></td><td><pre>	fifo<span class="token operator">-></span>in <span class="token operator">+=</span> len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token keyword">return</span> len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>我们先看 <code>kfifo_unused()</code> 这个函数。这个函数主要计算出 <code>kfifo</code> 中还有多少空用空间，主要通过以下两点实现：</p><ul><li><code>in</code> 和 <code>out</code> 都是 <code>unsigned int</code> ，<ul><li>这就使得无论两个的位置如何，相减总能得到两个数之间的差，即 <code>kfifo</code> 中的元素数量</li></ul></li><li><code>(mask+1)</code> 是整个 <code>kfifo</code> 的大小<ul><li><code>(mask+1)</code> 减去已经使用的元素数量，就能得到未使用的元素数量。</li></ul></li></ul><figure class="highlight c"><figcaption data-lang="c"><span>计算空间</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">kfifo_unused</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__kfifo</span> <span class="token operator">*</span>fifo<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">return</span> <span class="token punctuation">(</span>fifo<span class="token operator">-></span>mask <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>fifo<span class="token operator">-></span>in <span class="token operator">-</span> fifo<span class="token operator">-></span>out<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后看 <code>L31</code> ，这里做一个取小值，如果剩余的多则要入队的都可以加，如果剩余的少则要入队只能是剩下的个数。</p><p>然后就开始到入队的正式过程，也是环形缓冲区的真正体现。我们这里为了便于理解，我们进行以下的假设</p><ul><li>数据类型为 <code>char</code></li><li>数据类型所占的字节数 <code>esize</code> 为 1</li><li>数据的 <code>size</code> 为 8</li><li>已经使用的数量为 2</li></ul><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210422140929.png" alt="image-20210422140928997"></p><p>我们先跳过 <code>L8</code> 的 <code>off &amp;= fifo-&gt;mask;</code> ，先假设我们已经知道 <code>in/off</code> 为 6，然后看 <code>L14</code> ：</p><p><code>l = min(len, size - off)</code> ，这里对应的图中的 Step 1</p><ul><li><code>(size-off)</code> 计算的是偏移后面剩下的个数（包括使用的和未使用的）（这里是 2）</li><li><code>len</code> 就是能够写入数量（这里是 6），这里有一个恒等关系 <code>len &gt;= (size - off)</code></li><li>取小值，是获得写在数据右边的数量。</li></ul><p>然后使用 <code>memcpy(fifo-&gt;data + off, src, l);</code> 把数据写入到右侧</p><p>然后再使用 <code>memcpy(fifo-&gt;data, src + l, len - l);</code> 把数据写入到左侧 这里对应图中的 Step 2</p><p>在 <code>L35</code> 这里直接更新 <code>in</code> 的位置（这里是 10）这里对应图中的 Step 3。然后现在会过头来看我们刚才跳过的 <code>L8</code> 。</p><p>如果下一次继续入队两个元素，那么先执行 <code>L8</code> . <code>off &amp;= fifo-&gt;mask;</code></p><ul><li><code>in = 10 (1010b)</code></li><li><code>mask = 7 (0111b)</code></li><li><code>off = 2 (0010b)</code></li></ul><p>这样就完成了偏移的环形，而且不需要额外的判断。如果能够理解入队操作，那么出队操作也是类似的。</p><h3 id="并行无锁技术"><a class="anchor" href="#并行无锁技术">#</a> 并行无锁技术</h3><p>实际上是使用了内存屏障，我们知道 编译器编译源代码时，会将源代码进行优化，<strong>将源代码的指令进行重排序</strong>，以适合于 CPU 的并行执行。然而，内核同步必须避免指令重新排序，优化屏障（Optimization barrier）避免编译器的重排序优化操作，<strong>保证编译程序时在优化屏障之前的指令不会在优化屏障之后执行</strong>。具体关于内存屏障的讨论，我们会在缓存和内存相关内容时进行讨论，这里只是简单的理解。</p><p>软件可通过读写<strong>屏障强制内存访问次序</strong>。读写屏障像一堵墙，所有在设置读写屏障之前发起的内存访问，必须先于在设置屏障之后发起的内存访问之前完成，确保<strong>内存访问按程序的顺序完成</strong>。Linux 内核提供的内存屏障 API 函数说明如下表。内存屏障主要用于多处理器系统，使用 smp_xxx 函数。</p><table><thead><tr><th>指令</th><th>作用</th></tr></thead><tbody><tr><td><code>smp_rmb()</code></td><td>适用于多处理器的读内存屏障。</td></tr><tr><td><code>smp_wmb()</code></td><td>适用于多处理器的写内存屏障。</td></tr><tr><td><code>smp_mb()</code></td><td>适用于多处理器的内存屏障。</td></tr></tbody></table><div class="tags"><a href="/tags/Linux/" rel="tag"><i class="ic i-tag"></i> Linux</a> <a href="/tags/Kernel/" rel="tag"><i class="ic i-tag"></i> Kernel</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-04-25 21:19:48" itemprop="dateModified" datetime="2021-04-25T21:19:48+08:00">2021-04-25</time></span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80MzY4Ni8yMDIyNg=="><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Junwide Xiao 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Junwide Xiao 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Junwide Xiao <i class="ic i-at"><em>@</em></i>精神小伙</li><li class="link"><strong>本文链接：</strong> <a href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic%20II/" title="Kernel Module — Char Device Basic II">https://junwide.github.io/Linux-Basic/Kernel Module — Char Device Basic II/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;junwide&#x2F;blog&#x2F;raw&#x2F;master&#x2F;20210418104434.jpg" title="Kernel Module — Char Device  Driver"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Linux基础</span><h3>Kernel Module — Char Device Driver</h3></a></div><div class="item right"><a href="/Program/math02/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;junwide&#x2F;blog&#x2F;raw&#x2F;master&#x2F;20210418104501.jpg" title="Math in anywhere |  Vector"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 编程技术</span><h3>Math in anywhere | Vector</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#kernel-module-char-device-basic-ii"><span class="toc-number">1.</span> <span class="toc-text">Kernel Module — Char Device Basic II</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#misc-char-device"><span class="toc-number">1.1.</span> <span class="toc-text">MISC Char Device</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kernel-data-struct"><span class="toc-number">1.2.</span> <span class="toc-text">Kernel Data Struct</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#source-code"><span class="toc-number">1.3.</span> <span class="toc-text">Source Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#build-code"><span class="toc-number">1.4.</span> <span class="toc-text">Build Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#test"><span class="toc-number">1.5.</span> <span class="toc-text">Test</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#summary"><span class="toc-number">1.6.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#more-about-kfifo"><span class="toc-number">1.7.</span> <span class="toc-text">More About KFIFO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E6%95%88%E7%BC%96%E7%A8%8B%E7%90%86%E5%BF%B5"><span class="toc-number">1.7.1.</span> <span class="toc-text">高效编程理念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A7%E7%94%A8%E7%8E%AF%E5%BD%A2%E7%BC%93%E5%86%B2"><span class="toc-number">1.7.2.</span> <span class="toc-text">巧用环形缓冲</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E6%97%A0%E9%94%81%E6%8A%80%E6%9C%AF"><span class="toc-number">1.7.3.</span> <span class="toc-text">并行无锁技术</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/Linux-Basic/UPBoard%20%E4%BC%98%E5%8C%96%E4%BF%AE%E5%A4%8D%E6%8C%87%E5%8D%97/" rel="bookmark" title="UPBoard 优化修复指南">UPBoard 优化修复指南</a></li><li><a href="/Linux-Basic/Linux%20Kernel%20Build/" rel="bookmark" title="Linux Kernel Build">Linux Kernel Build</a></li><li><a href="/Linux-Basic/Linux%20%E8%A7%A3%E5%AF%86%E2%80%94CPU%E5%88%A9%E7%94%A8%E7%8E%87/" rel="bookmark" title="Linux 解密—CPU利用率">Linux 解密—CPU利用率</a></li><li><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Simple%20Example/" rel="bookmark" title="Kernel Module — Simple Example">Kernel Module — Simple Example</a></li><li><a href="/Linux-Basic/devnull%20%E2%80%94%E2%80%94The%20Bit%20Bucket/" rel="bookmark" title="/dev/null ——The Bit Bucket 的故事">/dev/null ——The Bit Bucket 的故事</a></li><li><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic/" rel="bookmark" title="Kernel Module — Char Device  Driver">Kernel Module — Char Device Driver</a></li><li class="active"><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic%20II/" rel="bookmark" title="Kernel Module — Char Device Basic II">Kernel Module — Char Device Basic II</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Junwide Xiao" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Junwide Xiao</p><div class="description" itemprop="description">生活与技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">25</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">24</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2p1bndpZGU=" title="https:&#x2F;&#x2F;github.com&#x2F;junwide"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29t" title="https:&#x2F;&#x2F;www.zhihu.com"><i class="ic i-zhihu"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20=" title="https:&#x2F;&#x2F;weibo.com"><i class="ic i-weibo"></i></span> <a href="https://junwide.github.io/about" title="https:&#x2F;&#x2F;junwide.github.io&#x2F;about" class="item about"><i class="ic i-address-card"></i></a> <span class="exturl item email" data-url="bWFpbHRvOmp1bndpZGVAb3V0bG9vay5jb20=" title="mailto:junwide@outlook.com"><i class="ic i-envelope"></i></span> <span class="exturl item youtube" data-url="aHR0cHM6Ly95b3V0dWJlLmNvbQ==" title="https:&#x2F;&#x2F;youtube.com"><i class="ic i-youtube"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/Program/math02/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Program/" title="分类于 编程技术">编程技术</a></div><span><a href="/Program/math02/" title="Math in anywhere |  Vector">Math in anywhere | Vector</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/theme-shoka-doc/" title="分类于 博客">博客</a></div><span><a href="/theme-shoka-doc/config/" title="Step.2 基本配置">Step.2 基本配置</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/embed-system/" title="分类于 嵌入式系统">嵌入式系统</a></div><span><a href="/embed-system/%E7%AE%80%E5%8D%95MCU%E8%AF%BE%E8%AE%BE%E5%BC%80%E6%BA%90--%E7%94%B5%E5%AD%90%E9%92%9F/" title="简单MCU课设开源--电子钟">简单MCU课设开源--电子钟</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/other/" title="分类于 杂项">杂项</a></div><span><a href="/Other/%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%8D%9A%E5%AE%A2%E5%88%9B%E4%BD%9C%E6%8C%87%E5%8D%97/" title="协作式博客创作指南">协作式博客创作指南</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Latex%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F%E8%A1%A8%E8%BE%BE%E4%BB%A5%E5%8F%8A%E5%85%B6%E4%BB%96MD%E5%BD%A2%E5%BC%8F/" title="Latex数学公式表达以及其他MD形式">Latex数学公式表达以及其他MD形式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/other/" title="分类于 杂项">杂项</a></div><span><a href="/Other/Tech%20New%20Innovation/" title="Tech New Innovation">Tech New Innovation</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/Linux%20%E8%A7%A3%E5%AF%86%E2%80%94CPU%E5%88%A9%E7%94%A8%E7%8E%87/" title="Linux 解密—CPU利用率">Linux 解密—CPU利用率</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Google_%E6%90%9C%E7%B4%A2%E6%8C%87%E5%8D%97/" title="谷歌搜索技巧">谷歌搜索技巧</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Git_%E7%9A%84%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8/" title="Git 的日常使用">Git 的日常使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/theme-shoka-doc/" title="分类于 博客">博客</a></div><span><a href="/theme-shoka-doc/theme-shoka-doc/" title="Hexo主题Shoka &amp; multi-markdown-it渲染器使用说明">Hexo主题Shoka & multi-markdown-it渲染器使用说明</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Junwide Xiao @ Brain Home</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">138k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:11</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Linux-Basic/Kernel Module — Char Device Basic II/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>