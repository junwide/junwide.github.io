<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="精神小伙" href="https://junwide.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="精神小伙" href="https://junwide.github.io/atom.xml"><link rel="alternate" type="application/json" title="精神小伙" href="https://junwide.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Linux,Kernel"><link rel="canonical" href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic/"><title>Kernel Module — Char Device Driver - Linux基础 | Brain Home = 精神小伙 = Tech.&Mem.</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Kernel Module — Char Device Driver</h1><div class="meta"><span class="item" title="创建时间：2021-03-29 12:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-03-29T12:00:00+08:00">2021-03-29</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>7.9k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>14 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Brain Home</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104627.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104617.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104434.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104501.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104415.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104528.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/linux-basic/" itemprop="item" rel="index" title="分类于 Linux基础"><span itemprop="name">Linux基础</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Junwide Xiao"><meta itemprop="description" content="Tech.&Mem., 生活与技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="精神小伙"></span><div class="body md" itemprop="articleBody"><h1 id="kernel-module-char-device-driver"><a class="anchor" href="#kernel-module-char-device-driver">#</a> Kernel Module — Char Device Driver</h1><p><img data-src="https://gitee.com/junwide/blog/raw/master/20200925102213.png" alt=""></p><p><strong>Goal</strong></p><p>上文我们基本了解了什么是内核模块和加载类型，并编写自己的第一个模块。而本文开始介绍 Linux 中内核模块中的字符设备驱动，了解字符设备驱动的特点和编写简单的字符驱动。</p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_0" disabled><label for="cbx_0">什么是字符设备</label></li><li class="task-list-item"><input type="checkbox" id="cbx_1" disabled><label for="cbx_1">字符设备的特点，常见的设备有</label></li><li class="task-list-item"><input type="checkbox" id="cbx_2" disabled><label for="cbx_2">一个字符设备组成的流程</label></li><li class="task-list-item"><input type="checkbox" id="cbx_3" disabled><label for="cbx_3">如何查看并创建一个控制节点</label></li></ul><p><strong>Preconditions</strong></p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_4" checked disabled><label for="cbx_4">了解 Make</label></li><li class="task-list-item"><input type="checkbox" id="cbx_5" checked disabled><label for="cbx_5">了解 C</label></li><li class="task-list-item"><input type="checkbox" id="cbx_6" checked disabled><label for="cbx_6">了解 Bash 语法</label></li><li class="task-list-item"><input type="checkbox" id="cbx_7" checked disabled><label for="cbx_7">了解上一篇的内容</label></li></ul><h2 id="what-is-device-driver"><a class="anchor" href="#what-is-device-driver">#</a> What is “Device Driver”</h2><p>设备驱动指的是操作系统和输入输出设备间的粘合剂，驱动负责将操作系统的请求传输，转化成特定物理设备控制器能够理解的命令。而内核模块就是驱动的载体。Linux 系统内核将设备对象的特征进行了抽象，总结除了以下三种模型：</p><ul><li><strong>Char Device Driver：</strong><ul><li>特点：是以字节为单位的 I/O 传输，这种字符流的传输率比较低</li><li>对象：鼠标，键盘，触摸屏</li></ul></li><li><strong>Block Device Driver：</strong><ul><li>特点：是以块为单位传输，这种的传输率比较高</li><li>对象：磁盘，闪存</li></ul></li><li><strong>Network Device Driver</strong><ul><li>涉及到网络协议层</li></ul></li></ul><h2 id="basic-char-device"><a class="anchor" href="#basic-char-device">#</a> Basic Char Device</h2><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210218184131.png" alt="image-20210218184131092"></p><h3 id="data-structure"><a class="anchor" href="#data-structure">#</a> Data Structure</h3><p>字符设备驱动管理的核心对象是以字符为传输流的设备，在 Linux 内核中，使用了一个 <code>struct cdev</code> 来进行描述其属性</p><figure class="highlight c"><figcaption data-lang="c"><span>主要数据结构</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>  <span class="token comment">// 这是用于设备驱动模型管理的结构</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span> <span class="token comment">// 字符设备驱动的内核模块对象指针，包含了模块的详细信息</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span> <span class="token comment">// 字符设备驱动的函数操作集</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>  <span class="token comment">// 一个 List_head 的链表结构，将所有设备驱动串起来</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token class-name">dev_t</span> dev<span class="token punctuation">;</span>   <span class="token comment">// 字符设备的设备号</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span> <span class="token comment">// 同属一个主设备号的次设备号个数</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span> __randomize_layout<span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>__randomize_layout：随机化重排内存排列，这是一种内核安全保护手段</p></blockquote><p>这里有两个重点理解的的内容</p><ul><li><p><code>dev_t</code> ：字符设备的设备号（是由主设备和次设备号的组成）</p><ul><li><p>主设备号：用来区分是什么类型的设备</p></li><li><p>次设备号：用来驱分同一类型内的多个设备</p></li><li><p>两个对应的宏：</p><ul><li><p><code>MAJOR</code> ：用来获取主设备号</p></li><li><p><code>MINOR</code> ：用来获取次设备号</p></li><li><figure class="highlight c"><figcaption data-lang="c"><span>宏操作</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MINORBITS</span>	<span class="token expression"><span class="token number">20</span> </span><span class="token comment">// 主设备和次设备的分界（后 20 为次，其他前面为主）</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MINORMASK</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> MINORBITS<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> </span><span class="token comment">// 获取次设备号的掩码</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAJOR</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">>></span> MINORBITS<span class="token punctuation">)</span><span class="token punctuation">)</span>  </span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MINOR</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">&amp;</span> MINORMASK<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MKDEV</span><span class="token expression"><span class="token punctuation">(</span>ma<span class="token punctuation">,</span>mi<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> MINORBITS<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>mi<span class="token punctuation">)</span><span class="token punctuation">)</span>  </span><span class="token comment">// 创建设备号的宏</span></span></pre></td></tr></table></figure></li></ul></li></ul></li><li><p><code>file_operations *</code> ：字符设备驱动的函数操作集</p><ul><li>这是一个结构体指针，这个结构体中包含了常用的函数操作定义</li><li>这是内核面向对象的体现，统一了上层的调用接口。而我们可以通过对函数指针指向来实现具体功能</li></ul></li></ul><p>这两个是字符设备驱动最核心部分，因为设备号的分配表示内核是否还有相关的资源。同时我们创建操作节点是也是需要依靠设备号来定位具体的设备，因为多个同类设备时使用统一的设备驱动，而之间主要的区分和定位方式就是利用设备号。而函数操作集则是我们实现具体驱动行为的关键，这部分的实现就要依据具体设备的数据手册来实现。</p><h3 id="init-framework"><a class="anchor" href="#init-framework">#</a> Init. Framework</h3><p>有了基本的数据结构，我们来看字符驱动初始化进行流程：</p><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210218182436.png" alt="image-20210218182429713"></p><ul><li><p>获取设备号：这是注册驱动的基石</p><ul><li><code>int alloc_chrdev_region(dev_t *dev, unsigned baseminor, unsigned count, const char *name)</code> (推荐使用这个)<ul><li>dev：分配到的设备号输出到 dev</li><li>baseminor：请求主设备号范围开始的第一个，也就是最小值</li><li>count：次设备数目</li><li>name：驱动名</li><li>返回值：0 为成功，负数为失败</li></ul></li><li><code>int register_chrdev_region(dev_t from, unsigned count, const char *name)</code><ul><li>from：手动分配设备号的其实设备号（需要自己查阅，系统没有分配的）</li><li>count：次设备的数量</li><li>name：驱动名</li><li>返回值：0 为成功，负数为失败</li></ul></li><li>以上两个 API 均能分配设备号，前者自动分配，后者需要手动</li><li>两个都通过调用： <code>__register_chrdev_region</code> 来完成分配</li></ul></li></ul><hr><ul><li><p>分配字符设备的数据结构：这是驱动的核心内容</p><ul><li><p><code>cdev_alloc()</code> ：向内核申请字符驱动的数据结构</p><ul><li>如果分配失败，那么整个后续无法进行，因此会释放到之前申请到设备号</li></ul></li><li><p>调用： <code>unregister_chrdev_region(dev,count)</code> 来释放回系统</p></li><li><p><code>cdev_init(struct cdev *cdev, const struct file_operations *fops)</code> ：初始化</p><ul><li><p>cdev：字符设备对象的数据</p></li><li><p>fops：对应的操作函数集，这里相当于函数重载的意思</p><ul><li><figure class="highlight c"><figcaption data-lang="c"><span>fops</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> demo_fops <span class="token operator">=</span>  <span class="token comment">// 对应的操作函数集</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">.</span>open  <span class="token operator">=</span> demo_open<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">.</span>release <span class="token operator">=</span> demo_release<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">.</span>read <span class="token operator">=</span> demo_read<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">.</span>write <span class="token operator">=</span> demo_write</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul></li><li><p>这个函数将字符设备的数据和函数操作关联起来</p></li></ul></li><li><p><code>cdev_add(struct cdev *p, dev_t dev, unsigned count)</code> ：将字符设备驱动加到系统中</p><ul><li>p：字符设备对象的指针</li><li>dev：设备号</li><li>count：次设备数量</li><li>返回值：0 为整个，负数为失败</li><li>失败处理：<ul><li>如果失败了，后续操作也无法执行，所以需要跳转到释放字符设备对象的数据</li><li>调用： <code>cdev_del(cdev * p)</code> 将 cdev 从系统中移除，并 freeing cdev 的数据结构</li><li>调用： <code>unregister_chrdev_region(dev,count)</code> 来释放回系统</li></ul></li></ul></li></ul></li><li><p>使用完的释放：遵循栈法则，后进先注销</p><ul><li>先处理：字符设备对象结构</li><li>后处理：给字符设备分配的设备号</li></ul></li></ul><h3 id="source-code"><a class="anchor" href="#source-code">#</a> Source Code</h3><figure class="highlight c"><figcaption data-lang="c"><span>demo.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEMO_NAME</span> <span class="token string">"demodriver"</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count <span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">;</span> <span class="token comment">// 在一个主设备号下，次设备数量统计</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">demoDriver_cdev</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">dev_t</span> dev <span class="token punctuation">;</span>    <span class="token comment">// 字符设备的设备号</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>pdev<span class="token punctuation">;</span>  <span class="token comment">// 字符设备的数据结构</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/* data 可以自定义数据 */</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span> demo_ctx <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token punctuation">.</span>dev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">.</span>pdev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span> inode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 我们将驱动做成一个设备节点，所以可以用 inode 结构来访问，驱动信息</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_rdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_rdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"%s: Major Num: %d , Minor Num: %d"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span>major<span class="token punctuation">,</span>minor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span> inode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">demo_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> lbuf<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="35"></td><td><pre>                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"%s enter"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">demo_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>\</pre></td></tr><tr><td data-num="41"></td><td><pre>                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"%s enter"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> demo_fops <span class="token operator">=</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">.</span>open  <span class="token operator">=</span> demo_open<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">.</span>release <span class="token operator">=</span> demo_release<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">.</span>read <span class="token operator">=</span> demo_read<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">.</span>write <span class="token operator">=</span> demo_write</pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">demo_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">// 系统自动分配一个主设备号，使用这个接口避免冲突，这里需要 4 个参数 cdev，baseminor ，count ，name</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>demo_ctx<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span>count<span class="token punctuation">,</span>DEMO_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"Faild in alloc char device region"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    demo_ctx<span class="token punctuation">.</span>pdev <span class="token operator">=</span> <span class="token function">cdev_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 申请设备数据结构</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>demo_ctx<span class="token punctuation">.</span>pdev<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"cdev_alloc faild"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">goto</span> unregister_chrdev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token function">cdev_init</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>pdev<span class="token punctuation">,</span><span class="token operator">&amp;</span>demo_fops<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结构体和操作函数的指针建立联系</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    ret <span class="token operator">=</span>  <span class="token function">cdev_add</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>pdev<span class="token punctuation">,</span>demo_ctx<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将设备添加到系统中，传入主设备号和次设备数目</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"cdev_add faild"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">goto</span> cdev_fail<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"success register char device: %s\n"</span><span class="token punctuation">,</span>DEMO_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"Major Num: %d , Minor Num: %d"</span><span class="token punctuation">,</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MINOR</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment">// 如果在注册驱动过程失败，则使用进行注销</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    cdev_fail<span class="token operator">:</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token function">cdev_del</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    unregister_chrdev<span class="token operator">:</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 卸载掉，释放回系统</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span>  __exit <span class="token function">demo_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"remove Device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>pdev<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        <span class="token function">cdev_del</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>demo_ctx<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token function">module_init</span><span class="token punctuation">(</span>demo_init<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token function">module_exit</span><span class="token punctuation">(</span>demo_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token comment">// 模块可选信息</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 许可证声明</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"junwide"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 作者声明</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"This module is a char device"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块描述</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token function">MODULE_VERSION</span><span class="token punctuation">(</span><span class="token string">"V1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块别名</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token function">MODULE_ALIAS</span><span class="token punctuation">(</span><span class="token string">"Char Modules"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块别名</span></pre></td></tr></table></figure><h3 id="build-code"><a class="anchor" href="#build-code">#</a> Build Code</h3><p>使用和之前一样的 Build Code 通用模板，不在赘述。</p><h3 id="usage"><a class="anchor" href="#usage">#</a> Usage</h3><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>make</code></td><td>编译 Modules 工程</td></tr><tr><td><code>sudo make install</code></td><td>将编译后的 Modules 放进系统目录，建立依赖关系，探测启动 modules</td></tr><tr><td><code>sudo make boot</code></td><td>将这个 modules 设置为开机自动加载</td></tr><tr><td><code>sudo make rboot</code></td><td>将这个 modules 的开机启动删除</td></tr><tr><td><code>sudo make clean</code></td><td>清空这个 modules 编译出来的所有东西</td></tr></tbody></table><h3 id="user-code"><a class="anchor" href="#user-code">#</a> <strong>User Code</strong></h3><p>用户测试代码，其原理就是打开字符设备，读取操作（实际没有读出内容），这里验证的是是否有跳进响应和函数中，</p><p>如果有跳进，可以通过 <code>dmesg</code> 进行查看</p><figure class="highlight c"><figcaption data-lang="c"><span>test.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEMO_DEV_NAME</span> <span class="token string">"/dev/demodriver"</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">int</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>	fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>DEMO_DEV_NAME<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open device %s failded\n"</span><span class="token punctuation">,</span> DEMO_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="test"><a class="anchor" href="#test">#</a> Test</h3><p>这篇我们讨论的驱动需要总共有 3 个文件</p><ul><li><code>demo.c</code> ：驱动模块代码</li><li><code>Makefiele</code> ：构建代码</li><li><code>Test.c</code> ：测试代码</li></ul><ol><li>编译驱动代码和测试代码</li></ol><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">make</span> <span class="token comment"># 编译驱动代码</span></pre></td></tr><tr><td data-num="2"></td><td data-command="[junwide@mic] $"></td><td><pre>gcc test.c -o <span class="token builtin class-name">test</span> --static  <span class="token comment">#编译测试代码</span></pre></td></tr><tr><td data-num="3"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> <span class="token builtin class-name">test</span>   <span class="token comment">#赋予文件执行权限</span></pre></td></tr></table></figure><ol start="2"><li>载入驱动并查看分配到的主设备号</li></ol><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">sudo</span> insmod xx.ko</pre></td></tr><tr><td data-num="2"></td><td data-command=""></td><td><pre><span class="token comment">#使用任意一种查看设备号</span></pre></td></tr><tr><td data-num="3"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">cat</span> /proc/devices <span class="token comment">#查看设备号 </span></pre></td></tr><tr><td data-num="4"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">dmesg</span> <span class="token comment"># 查看主设备号</span></pre></td></tr></table></figure><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210217181113.png" alt="image-20200925155857177"></p><ol start="3"><li>创建操作节点并进行测试</li></ol><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> <span class="token function">mknod</span> /dev/demodriver c <span class="token number">238</span> <span class="token number">0</span> <span class="token comment">#创建设备节点</span></pre></td></tr><tr><td data-num="2"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> ./test</pre></td></tr><tr><td data-num="3"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">dmesg</span>   <span class="token comment">#查看消息</span></pre></td></tr></table></figure><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210217181113.png" alt="image-20200925160425610"></p><ol start="4"><li>完成测试退出</li></ol><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command=""></td><td><pre><span class="token comment">#退出顺序</span></pre></td></tr><tr><td data-num="2"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> rmmod _demoDriver</pre></td></tr><tr><td data-num="3"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> <span class="token function">rm</span> /dev/demodriver</pre></td></tr><tr><td data-num="4"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> <span class="token function">make</span> clean</pre></td></tr></table></figure><h2 id="summary"><a class="anchor" href="#summary">#</a> Summary</h2><p>本文主要介绍了字符型驱动的知识相关，以及编写一个字符型驱动的全流程和测试过程</p><h2 id="appendix"><a class="anchor" href="#appendix">#</a> Appendix</h2><p>函数操作集的重载编写要注意的是：参数要和以下的统一，</p><figure class="highlight c"><figcaption data-lang="c"><span>file_fops</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token class-name">loff_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>llseek<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_iter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write_iter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>iopoll<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span>kiocb<span class="token punctuation">,</span> bool spin<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>iterate<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dir_context</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>iterate_shared<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dir_context</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token function">__poll_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlocked_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>compat_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> mmap_supported_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fl_owner_t</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fsync<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">int</span> datasync<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fasync<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>sendpage<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_unmapped_area<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>check_flags<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setfl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>splice_write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pipe_inode_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>splice_read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pipe_inode_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setlease<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>fallocate<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> offset<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			  <span class="token class-name">loff_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>show_fdinfo<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONFIG_MMU</span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap_capabilities<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>copy_file_range<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	<span class="token class-name">loff_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>remap_file_range<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file_in<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> pos_in<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>				   <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file_out<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> pos_out<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>				   <span class="token class-name">loff_t</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> remap_flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fadvise<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span> __randomize_layout<span class="token punctuation">;</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/Linux/" rel="tag"><i class="ic i-tag"></i> Linux</a> <a href="/tags/Kernel/" rel="tag"><i class="ic i-tag"></i> Kernel</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-04-18 20:47:09" itemprop="dateModified" datetime="2021-04-18T20:47:09+08:00">2021-04-18</time></span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80MzY4Ni8yMDIyNg=="><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Junwide Xiao 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Junwide Xiao 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Junwide Xiao <i class="ic i-at"><em>@</em></i>精神小伙</li><li class="link"><strong>本文链接：</strong> <a href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic/" title="Kernel Module — Char Device  Driver">https://junwide.github.io/Linux-Basic/Kernel Module — Char Device Basic/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Linux-Basic/devnull%20%E2%80%94%E2%80%94The%20Bit%20Bucket/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;junwide&#x2F;blog&#x2F;raw&#x2F;master&#x2F;20210418104627.jpg" title="&#x2F;dev&#x2F;null ——The Bit Bucket 的故事"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Linux基础</span><h3>/dev/null ——The Bit Bucket 的故事</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#kernel-module-char-device-driver"><span class="toc-number">1.</span> <span class="toc-text">Kernel Module — Char Device Driver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#what-is-device-driver"><span class="toc-number">1.1.</span> <span class="toc-text">What is “Device Driver”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#basic-char-device"><span class="toc-number">1.2.</span> <span class="toc-text">Basic Char Device</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#data-structure"><span class="toc-number">1.2.1.</span> <span class="toc-text">Data Structure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init-framework"><span class="toc-number">1.2.2.</span> <span class="toc-text">Init. Framework</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#source-code"><span class="toc-number">1.2.3.</span> <span class="toc-text">Source Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#build-code"><span class="toc-number">1.2.4.</span> <span class="toc-text">Build Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#usage"><span class="toc-number">1.2.5.</span> <span class="toc-text">Usage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#user-code"><span class="toc-number">1.2.6.</span> <span class="toc-text">User Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test"><span class="toc-number">1.2.7.</span> <span class="toc-text">Test</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#summary"><span class="toc-number">1.3.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#appendix"><span class="toc-number">1.4.</span> <span class="toc-text">Appendix</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/Linux-Basic/UPBoard%20%E4%BC%98%E5%8C%96%E4%BF%AE%E5%A4%8D%E6%8C%87%E5%8D%97/" rel="bookmark" title="UPBoard 优化修复指南">UPBoard 优化修复指南</a></li><li><a href="/Linux-Basic/Linux%20Kernel%20Build/" rel="bookmark" title="Linux Kernel Build">Linux Kernel Build</a></li><li><a href="/Linux-Basic/Linux%20%E8%A7%A3%E5%AF%86%E2%80%94CPU%E5%88%A9%E7%94%A8%E7%8E%87/" rel="bookmark" title="Linux 解密—CPU利用率">Linux 解密—CPU利用率</a></li><li><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Simple%20Example/" rel="bookmark" title="Kernel Module — Simple Example">Kernel Module — Simple Example</a></li><li><a href="/Linux-Basic/devnull%20%E2%80%94%E2%80%94The%20Bit%20Bucket/" rel="bookmark" title="/dev/null ——The Bit Bucket 的故事">/dev/null ——The Bit Bucket 的故事</a></li><li class="active"><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic/" rel="bookmark" title="Kernel Module — Char Device  Driver">Kernel Module — Char Device Driver</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Junwide Xiao" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Junwide Xiao</p><div class="description" itemprop="description">生活与技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">22</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">21</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2p1bndpZGU=" title="https:&#x2F;&#x2F;github.com&#x2F;junwide"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29t" title="https:&#x2F;&#x2F;www.zhihu.com"><i class="ic i-zhihu"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20=" title="https:&#x2F;&#x2F;weibo.com"><i class="ic i-weibo"></i></span> <a href="https://junwide.github.io/about" title="https:&#x2F;&#x2F;junwide.github.io&#x2F;about" class="item about"><i class="ic i-address-card"></i></a> <span class="exturl item email" data-url="bWFpbHRvOmp1bndpZGVAb3V0bG9vay5jb20=" title="mailto:junwide@outlook.com"><i class="ic i-envelope"></i></span> <span class="exturl item youtube" data-url="aHR0cHM6Ly95b3V0dWJlLmNvbQ==" title="https:&#x2F;&#x2F;youtube.com"><i class="ic i-youtube"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/other/" title="分类于 杂项">杂项</a></div><span><a href="/Other/Tech%20New%20Innovation/" title="Tech New Innovation">Tech New Innovation</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Git_%E7%9A%84%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8/" title="Git 的日常使用">Git 的日常使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/embed-system/" title="分类于 嵌入式系统">嵌入式系统</a></div><span><a href="/embed-system/%E7%AE%80%E5%8D%95MCU%E8%AF%BE%E8%AE%BE%E5%BC%80%E6%BA%90--%E7%94%B5%E5%AD%90%E9%92%9F/" title="简单MCU课设开源--电子钟">简单MCU课设开源--电子钟</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Google_%E6%90%9C%E7%B4%A2%E6%8C%87%E5%8D%97/" title="谷歌搜索技巧">谷歌搜索技巧</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Latex%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F%E8%A1%A8%E8%BE%BE%E4%BB%A5%E5%8F%8A%E5%85%B6%E4%BB%96MD%E5%BD%A2%E5%BC%8F/" title="Latex数学公式表达以及其他MD形式">Latex数学公式表达以及其他MD形式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/other/" title="分类于 杂项">杂项</a></div><span><a href="/Other/%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%8D%9A%E5%AE%A2%E5%88%9B%E4%BD%9C%E6%8C%87%E5%8D%97/" title="协作式博客创作指南">协作式博客创作指南</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/theme-shoka-doc/" title="分类于 博客">博客</a></div><span><a href="/theme-shoka-doc/dependents/" title="Step.1 依赖插件">Step.1 依赖插件</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/Linux%20Kernel%20Build/" title="Linux Kernel Build">Linux Kernel Build</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/embed-system/" title="分类于 嵌入式系统">嵌入式系统</a></div><span><a href="/embed-system/ARM_Architecture/" title="ARM-Architecture">ARM-Architecture</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/theme-shoka-doc/" title="分类于 博客">博客</a></div><span><a href="/theme-shoka-doc/display/" title="Step.3 界面显示">Step.3 界面显示</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Junwide Xiao @ Brain Home</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">107k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">3:14</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Linux-Basic/Kernel Module — Char Device Basic/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>