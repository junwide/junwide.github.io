<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="精神小伙" href="https://junwide.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="精神小伙" href="https://junwide.github.io/atom.xml"><link rel="alternate" type="application/json" title="精神小伙" href="https://junwide.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Linux,Kernel"><link rel="canonical" href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Simple%20Example/"><title>Kernel Module — Simple Example - Linux基础 | Brain Home = 精神小伙 = Tech.&Mem.</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Kernel Module — Simple Example</h1><div class="meta"><span class="item" title="创建时间：2021-03-22 12:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-03-22T12:00:00+08:00">2021-03-22</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>6k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>11 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Brain Home</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104617.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104136.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104528.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104434.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104627.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104513.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/linux-basic/" itemprop="item" rel="index" title="分类于 Linux基础"><span itemprop="name">Linux基础</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Simple%20Example/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Junwide Xiao"><meta itemprop="description" content="Tech.&Mem., 生活与技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="精神小伙"></span><div class="body md" itemprop="articleBody"><h1 id="kernel-module-simple-example"><a class="anchor" href="#kernel-module-simple-example">#</a> Kernel Module — Simple Example</h1><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210211131217.png" alt="Kernel modules"></p><p><strong>Goal</strong></p><p>上文我们介绍了内核的环境的构建，其中介绍了在设置编译选项的时候可以选择是否编译成内核模块或者直接编译在内核内的方式。本文就从编译成内核模块的这一点为切入口，了解 Linux 的内核模块机制，并动手编写自己的内核模块</p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_0" disabled><label for="cbx_0">什么是内核模块</label></li><li class="task-list-item"><input type="checkbox" id="cbx_1" disabled><label for="cbx_1">内核模块的加载类型</label></li><li class="task-list-item"><input type="checkbox" id="cbx_2" disabled><label for="cbx_2">编写一个自己的内核模块</label></li><li class="task-list-item"><input type="checkbox" id="cbx_3" disabled><label for="cbx_3">如何进行内核模块测试</label></li></ul><p><strong>Preconditions</strong></p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_4" checked disabled><label for="cbx_4">了解 Make</label></li><li class="task-list-item"><input type="checkbox" id="cbx_5" checked disabled><label for="cbx_5">了解 C</label></li><li class="task-list-item"><input type="checkbox" id="cbx_6" checked disabled><label for="cbx_6">了解 Bash 语法</label></li></ul><h2 id="what-is-kernel-module"><a class="anchor" href="#what-is-kernel-module">#</a> What is “Kernel Module”</h2><p>Linux 内核使用宏内核的架构，也就是操作系统内核包含了进程管理，内存管理，进程调度，设备管理等基本的资源管理组件，并且大都在特权模式<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>下进行的。这一部分被编译进内核的各个组件，无法被我们再进行修改和调试，他将成为内核的一部分，和内核一起作为一个整体存在。从这个角度看这部分可以看作是静态内核模块。</p><p>既然有静态部分，那么相应就有动态的部分。还记得我们在搭建内核环境时，能够设置为编译成内核模块的部分吗？事实上，这些便是动态的内核模块，为什么需要这一部分的存在呢？还记得静态内核的特点吗？他已经成为内核的一部分，无法作为单独的一个部分进行修改和调试，如果要改动，就需要把整个内核进行从头编译，效率非常低，这种方式加载内存方式叫做：<strong>静态加载</strong>。而动态内核模块的引入，实际上就是为了解决内核开发者的问题，在内核运行起来后能够加载新编写驱动的机制，我们称之为：<strong>动态加载</strong>。因为这种方式，实际上放开了内核模块的管控，任何用户都能编写自己的内核模块加载到内核。而这样导致了内核会因为用户编写的代码，内核变得不安全和不稳定。这一部分就对程序员的编写代码能力要求非常高。</p><p>而动态加载最主要是以下两个技术</p><ul><li><strong>LKM（Loadable Kernel Module）</strong></li><li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Dynamic_Kernel_Module_Support_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)"><strong>DKMS（Dynamic Kernel Module Support）</strong></a></li></ul><p>我们这里只讨论 LKM，如果对 DKMS 机制有想了解的话，可以通过链接了解其相关知识。LKM 作为最通用，也是最经典的内核机制，我们将把重点放到这个的讨论上。</p><blockquote><p>LKM：通常用于添加对新硬件（作为设备驱动程序）和 / 或文件系统的支持，或用于添加系统调用。当不再需要 LKM 提供的功能时，可以将其卸载以释放内存和其他资源。</p></blockquote><h2 id="basic-ops"><a class="anchor" href="#basic-ops">#</a> Basic Ops</h2><table><thead><tr><th>命令</th><th>意义</th></tr></thead><tbody><tr><td><code>lsmod</code></td><td>查看加载进的内核的 Module 状态</td></tr><tr><td><code>modinfo xx(object)</code></td><td>查看目标内核模块的信息</td></tr><tr><td><code>sudo insmod xxx.ko</code></td><td>将内核模块加载进内核</td></tr><tr><td><code>sudo rmmod xxx</code></td><td>将内核模块从内核中删除</td></tr><tr><td><code>sudo modprobe xxx</code></td><td>在内核模块目录中加载 (需要将对象放到该目录)</td></tr><tr><td><code>sudo depmod -a</code></td><td>重建内核模块的依赖</td></tr></tbody></table><h2 id="example-modules"><a class="anchor" href="#example-modules">#</a> Example Modules</h2><p>以一个最简单的 Kernel Module 来介绍内核模块的构成，我们完成的介绍一个内核模块的编写和构建文件 Makefile 的编写</p><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210211132645.png" alt="image-20210211132644986"></p><h3 id="source-code"><a class="anchor" href="#source-code">#</a> Source Code</h3><p>这一部分介绍会使用到的宏和函数。</p><ul><li>注册<ul><li><code>module_init(func_name)</code> :<ul><li>模块的入口定义</li><li>这是系统注册会执行的函数，这个宏填入你的初始化函数名</li></ul></li><li><code>module_exit(func_name)</code> ：<ul><li>模块的出口定义</li><li>这是系统注销会执行的函数，这个宏填入你的注销退出的函数名</li></ul></li></ul></li><li>函数<ul><li><code>static void</code> :<ul><li>使用这个类型，使得其他文件对该函数不可见</li><li>其他文件可以定义重名的文件，而不会起冲突（这样不会和内核函数命名冲突）</li><li>该类型函数会被分配一个一直使用的存储区，直到退出该程序，避免多次调用函数压栈出栈</li></ul></li><li><code>__init __exit</code> :<ul><li>函数在链接的时候都放在 <code>.init.text</code> 这个区段</li><li>在初始化完成后，用这些关键字标识的函数或数据所占的内存会被释放掉。</li></ul></li></ul></li><li>信息<ul><li><code>MODULE_'xxxx'</code> :<ul><li>使用协议，作者，描述，别名</li></ul></li><li><code>EXPORT_SYMBOL</code> :<ul><li>对其他模块可见的函数</li></ul></li></ul></li></ul><p>了解完这些基本的概念后，我们开始来编写实际的代码，并把这些元素用上：</p><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">mkdir</span> km_test</pre></td></tr><tr><td data-num="2"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token builtin class-name">cd</span> km_test</pre></td></tr><tr><td data-num="3"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">vim</span> hello.c</pre></td></tr></table></figure><p><strong>Code：</strong></p><figure class="highlight c"><figcaption data-lang="c"><span>hello.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// 内核模块头文件</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span>     <span class="token comment">// 相关初始化头文件</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_test_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>   <span class="token comment">// 载入初始函数 </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG <span class="token string">"hello world!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_test_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>   <span class="token comment">// 卸载退出函数</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"nice try\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">int</span> <span class="token function">add_sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span>    <span class="token comment">// 提供给外部的函数</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token function">module_init</span><span class="token punctuation">(</span>my_test_init<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 注册</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token function">module_exit</span><span class="token punctuation">(</span>my_test_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>add_sum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 导出全局 modules 可见</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// 模块的相关信息 </span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 协议</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"junwide"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 作者</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"my first kernel module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 描述</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token function">MODULE_ALIAS</span><span class="token punctuation">(</span><span class="token string">"mytest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 代称</span></pre></td></tr></table></figure><h3 id="build-code"><a class="anchor" href="#build-code">#</a> Build Code</h3><p>这一部分对照这下面 <code>Code</code> 部分去看，我对编写的构建代码比较全面，并且具有通用性。</p><ul><li>编译</li><li><code>ifneq ($(KERNELRELEASE),)</code><ul><li>用来判断是否是第一次执行这个 <code>Makefile</code></li><li>注意逗号后面是空，空就是 NULL</li></ul></li><li><code>name</code> ：建议内核模块的前缀加上下划线</li><li><code>$(name)-objs</code> ：这是模块对象依赖的文件</li><li><code>obj-m</code> ： 这是模块名</li><li><code>KDIR</code> ：<ul><li>这是编译内核的 Source Code 路径</li><li>如果是交叉编译，就是对应 ARCH 下的源码路径</li></ul></li><li>功能：</li><li>install：这里完成的是自动化把 Module 安装为可识别 Module<ul><li>第一步：将文件拷到内核 module 的默认读取目录</li><li>第二步：内核重新扫描所有存在内核并关联他的依赖</li><li>第三步：使用 <code>Modprobe</code> 自动加载 Module 进内核</li></ul></li><li>boot：这里完成的是将内核模块写入内核自启中</li><li>rboot：这里完成的是取消内核模块自启</li><li>clean：<ul><li>第一步：清空编译产生的文件</li><li>第二步：去除掉加载系统目录中的文件</li><li>第三步：重新建立新的依赖</li></ul></li></ul><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token builtin class-name">cd</span> km_test</pre></td></tr><tr><td data-num="2"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">vim</span> Makefile</pre></td></tr></table></figure><p><strong>Code：</strong></p><figure class="highlight makefile"><figcaption data-lang="makefile"><span>构建文件</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#第一次执行 KERNELRELEASE 是空的，所以执行 else 里面的</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">ifneq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span>,<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>name <span class="token operator">=</span> _hello</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>-objs <span class="token operator">:=</span>hello.o</pre></td></tr><tr><td data-num="5"></td><td><pre>obj-m <span class="token operator">:=</span><span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>.o</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#else 块</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="8"></td><td><pre>name <span class="token operator">=</span> _hello</pre></td></tr><tr><td data-num="9"></td><td><pre>KDIR<span class="token operator">:=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">shell</span> uname -r<span class="token punctuation">)</span>/build </pre></td></tr><tr><td data-num="10"></td><td><pre>INSTALL_MOD_PATH <span class="token operator">=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">shell</span> uname -r<span class="token punctuation">)</span>/</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token symbol">all</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules   <span class="token comment">#编译</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token symbol">install</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	cp <span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>.ko <span class="token variable">$</span><span class="token punctuation">(</span>INSTALL_MOD_PATH<span class="token punctuation">)</span><span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>.ko  <span class="token comment">#将 modules 复制到指定目录</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	depmod -a         <span class="token comment"># 并更新依赖环境</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	modprobe <span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>   <span class="token comment"># 加载 Modules</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token symbol">boot</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	echo <span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> >> /etc/modules-load.d/modules.conf  <span class="token comment">#加入开启自启</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token symbol">rboot</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	sed -i <span class="token string">"/$&#123;name&#125;/d"</span> /etc/modules-load.d/modules.conf  <span class="token comment"># 删除开机自启</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token symbol">clean</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	rm -f *.ko *.o *.mod.o *.mod.c *.symvers *.order *.mod</pre></td></tr><tr><td data-num="23"></td><td><pre>	rm -f <span class="token variable">$</span><span class="token punctuation">(</span>INSTALL_MOD_PATH<span class="token punctuation">)</span><span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>.ko</pre></td></tr><tr><td data-num="24"></td><td><pre>	depmod -a</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">endif</span></pre></td></tr></table></figure><h3 id="usage"><a class="anchor" href="#usage">#</a> Usage</h3><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>make</code></td><td>编译 Modules 工程</td></tr><tr><td><code>sudo make install</code></td><td>将编译后的 Modules 放进系统目录，建立依赖关系，探测启动 modules</td></tr><tr><td><code>sudo make boot</code></td><td>将这个 modules 设置为开机自动加载</td></tr><tr><td><code>sudo make rboot</code></td><td>将这个 modules 的开机启动删除</td></tr><tr><td><code>sudo make clean</code></td><td>清空这个 modules 编译出来的所有东西</td></tr></tbody></table><h3 id="test"><a class="anchor" href="#test">#</a> Test</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ <span class="token function">make</span> <span class="token comment">#编译</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ <span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span> <span class="token comment"># 安装并启动</span></pre></td></tr><tr><td data-num="3"></td><td><pre>$ <span class="token function">dmesg</span>   <span class="token comment">#查看消息</span></pre></td></tr></table></figure><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210211130108.png" alt="image-20200925135813926"></p><h2 id="multi-modules"><a class="anchor" href="#multi-modules">#</a> Multi Modules</h2><p>正如我们一般开发程序一样，需要多个文件函数相互调用，相互操作。内核模块也可以做到，不过在 coding 上和用户态程序有一些不一样，具体如下所示：</p><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210217175616.png" alt="image-20210217175616785"></p><h3 id="source-code-2"><a class="anchor" href="#source-code-2">#</a> Source Code</h3><p><strong>模块之间相互调用需要注意</strong></p><ul><li><strong>被调用者：</strong><ul><li><code>EXPORT_SYMBOL()</code> ：需要对其他模块可见的函数 / 变量，再上一个例子中我们没解释的部分，就是这个声明。</li></ul></li><li><strong>调用者：</strong><ul><li><code>extern</code> ：声明其他函数定义过</li></ul></li><li><strong>Makefile</strong>：<ul><li>调用者在 Makefile 中需要加入 <code>KBUILD_EXTRA_SYMBOLS</code> 指明被调用者的 <code>Module.symvers</code></li><li>模块的依赖关系建立后，被调用者必须先加载到内核，调用者才可以加载进去</li><li>调用者设置为开启自启后，所依赖的被调用模块会自动加载到自动开机中</li></ul></li></ul><p><strong>使用参数时：</strong></p><ul><li>类型：<ul><li><code>static</code> ：内核程序的全局变量建议使用 <code>static</code></li></ul></li><li>声明<ul><li><code>module_param:</code> 用于声明这是内核的可接受参数变量<ul><li>参数 1：变量命</li><li>参数 2：类型</li><li>参数 3：权限 （具体参见 <code>stat.h</code> ）</li></ul></li></ul></li></ul><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token comment">#bash</span></pre></td></tr><tr><td data-num="2"></td><td data-command=""></td><td><pre><span class="token function">vim</span> add.c</pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"><span>add.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><hr><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command="[junwide@mic] $"></td><td><pre><span class="token function">vim</span> cite_test.c</pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"><span>cite_test.c</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 模块参数</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token string">"yuwei xiao"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//S_IRUGO 是参数权限，也可以用数字</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">module_param</span><span class="token punctuation">(</span>age<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">,</span>S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">module_param</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>charp<span class="token punctuation">,</span>S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 使用外部文件函数</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 声明 外部内核符号 函数</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">add_sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">cite_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     <span class="token comment">// 多文件编译</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"Test hi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">int</span> vle<span class="token operator">=</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"add value:%d\n"</span><span class="token punctuation">,</span>vle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 模块参数</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>     <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">" name : %s\n"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>     <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">" age : %d\n"</span><span class="token punctuation">,</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 使用其他模块的函数 (内核符号导出)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">int</span> adds<span class="token operator">=</span><span class="token function">add_sum</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">" add_sum : %d\n"</span><span class="token punctuation">,</span>adds<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">cite_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_EMERG<span class="token string">"param exit!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token function">module_init</span><span class="token punctuation">(</span>cite_init<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token function">module_exit</span><span class="token punctuation">(</span>cite_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">// 模块可选信息</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 许可证声明</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"junwide"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 作者声明</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"This module is a param example."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块描述</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token function">MODULE_VERSION</span><span class="token punctuation">(</span><span class="token string">"V1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块别名</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token function">MODULE_ALIAS</span><span class="token punctuation">(</span><span class="token string">"a simple module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 模块别名</span></pre></td></tr></table></figure><h3 id="build-code-2"><a class="anchor" href="#build-code-2">#</a> Build Code</h3><p>我们这里主要关注被调用者符号这部分</p><p><strong>Makefile</strong></p><ul><li>编译：<ul><li><code>KBUILD_EXTRA_SYMBOLS</code> ：<ul><li>这是被调用者的 Symver 文件</li><li>将文件路径导入系统变量</li></ul></li></ul></li></ul><blockquote><p>symvers contains a list of all exported symbols from a kernel build. During a kernel build the symvers or symbol versions file will be generated</p></blockquote><figure class="highlight makefile"><figcaption data-lang="makefile"><span>构建文件</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#第一次执行 KERNELRELEASE 是空的，所以执行 else 里面的</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">ifneq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span>,<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>name <span class="token operator">=</span> _cite</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>-objs <span class="token operator">:=</span> cite_test.o add.o</pre></td></tr><tr><td data-num="5"></td><td><pre>obj-m <span class="token operator">:=</span><span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>.o</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="8"></td><td><pre>name <span class="token operator">=</span> _cite  <span class="token comment">#变量名称</span></pre></td></tr><tr><td data-num="9"></td><td><pre>KBUILD_EXTRA_SYMBOLS <span class="token operator">+=</span> /home/junwide/Kernel_Module/hello/Module.symvers <span class="token comment">#被调用者符号</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">export</span> KBUILD_EXTRA_SYMBOLS  <span class="token comment"># 导入进编译环境</span></pre></td></tr><tr><td data-num="11"></td><td><pre>KDIR<span class="token operator">:=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">shell</span> uname -r<span class="token punctuation">)</span>/build </pre></td></tr><tr><td data-num="12"></td><td><pre>INSTALL_MOD_PATH <span class="token operator">=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">shell</span> uname -r<span class="token punctuation">)</span>/</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token symbol">all</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token symbol">install</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	cp <span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>.ko <span class="token variable">$</span><span class="token punctuation">(</span>INSTALL_MOD_PATH<span class="token punctuation">)</span><span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>.ko</pre></td></tr><tr><td data-num="17"></td><td><pre>	depmod -a</pre></td></tr><tr><td data-num="18"></td><td><pre>	modprobe <span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token symbol">boot</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	echo <span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> >> /etc/modules-load.d/modules.conf </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token symbol">rboot</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	sed -i <span class="token string">"/$&#123;name&#125;/d"</span> /etc/modules-load.d/modules.conf  <span class="token comment">#删除有配置的那一行</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token symbol">clean</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	rm -f *.ko *.o *.mod.o *.mod.c *.symvers *.order *.mod</pre></td></tr><tr><td data-num="25"></td><td><pre>	rm -f <span class="token variable">$</span><span class="token punctuation">(</span>INSTALL_MOD_PATH<span class="token punctuation">)</span><span class="token variable">$</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>.ko</pre></td></tr><tr><td data-num="26"></td><td><pre>	depmod -a</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">endif</span></pre></td></tr></table></figure><h3 id="usage-2"><a class="anchor" href="#usage-2">#</a> Usage</h3><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>make</code></td><td>编译 Modules 工程</td></tr><tr><td><code>sudo make install</code></td><td>将编译后的 Modules 放进系统目录，建立依赖关系，探测启动 modules</td></tr><tr><td><code>sudo make boot</code></td><td>将这个 modules 设置为开机自动加载</td></tr><tr><td><code>sudo make rboot</code></td><td>将这个 modules 的开机启动删除</td></tr><tr><td><code>sudo make clean</code></td><td>清空这个 modules 编译出来的所有东西</td></tr></tbody></table><h3 id="test-2"><a class="anchor" href="#test-2">#</a> <strong>Test</strong></h3><figure class="highlight bash"><figcaption data-lang="bash"><span>命令行提示符</span></figcaption><table><tr><td data-num="1"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">make</span> <span class="token comment">#编译</span></pre></td></tr><tr><td data-num="2"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> insmod _hello.ko</pre></td></tr><tr><td data-num="3"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> insmod _cite.ko <span class="token assign-left variable">name</span><span class="token operator">=</span>yuwei.shuai</pre></td></tr><tr><td data-num="4"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">dmesg</span>   <span class="token comment">#查看消息</span></pre></td></tr><tr><td data-num="5"></td><td data-command=""></td><td><pre><span class="token comment">#退出顺序</span></pre></td></tr><tr><td data-num="6"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> rmmod _cite</pre></td></tr><tr><td data-num="7"></td><td data-command="[junwide@mic] $"></td><td><pre>$ <span class="token function">sudo</span> rmmod _hello</pre></td></tr></table></figure><p><img data-src="https://gitee.com/junwide/blog/raw/master/20210217173658.png" alt="image-20200925140412444"></p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>特权模式：指的是拥有最高的权限对系统资源进行调用 <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section><div class="tags"><a href="/tags/Linux/" rel="tag"><i class="ic i-tag"></i> Linux</a> <a href="/tags/Kernel/" rel="tag"><i class="ic i-tag"></i> Kernel</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-04-19 23:43:53" itemprop="dateModified" datetime="2021-04-19T23:43:53+08:00">2021-04-19</time></span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80MzY4Ni8yMDIyNg=="><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Junwide Xiao 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Junwide Xiao 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Junwide Xiao <i class="ic i-at"><em>@</em></i>精神小伙</li><li class="link"><strong>本文链接：</strong> <a href="https://junwide.github.io/Linux-Basic/Kernel%20Module%20%E2%80%94%20Simple%20Example/" title="Kernel Module — Simple Example">https://junwide.github.io/Linux-Basic/Kernel Module — Simple Example/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Linux-Basic/Linux%20%E8%A7%A3%E5%AF%86%E2%80%94CPU%E5%88%A9%E7%94%A8%E7%8E%87/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;junwide&#x2F;blog&#x2F;raw&#x2F;master&#x2F;20210418104501.jpg" title="Linux 解密—CPU利用率"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Linux基础</span><h3>Linux 解密—CPU利用率</h3></a></div><div class="item right"><a href="/Linux-Basic/devnull%20%E2%80%94%E2%80%94The%20Bit%20Bucket/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;junwide&#x2F;blog&#x2F;raw&#x2F;master&#x2F;20210418104528.jpg" title="&#x2F;dev&#x2F;null ——The Bit Bucket 的故事"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Linux基础</span><h3>/dev/null ——The Bit Bucket 的故事</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#kernel-module-simple-example"><span class="toc-number">1.</span> <span class="toc-text">Kernel Module — Simple Example</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#what-is-kernel-module"><span class="toc-number">1.1.</span> <span class="toc-text">What is “Kernel Module”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#basic-ops"><span class="toc-number">1.2.</span> <span class="toc-text">Basic Ops</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#example-modules"><span class="toc-number">1.3.</span> <span class="toc-text">Example Modules</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#source-code"><span class="toc-number">1.3.1.</span> <span class="toc-text">Source Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#build-code"><span class="toc-number">1.3.2.</span> <span class="toc-text">Build Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#usage"><span class="toc-number">1.3.3.</span> <span class="toc-text">Usage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test"><span class="toc-number">1.3.4.</span> <span class="toc-text">Test</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#multi-modules"><span class="toc-number">1.4.</span> <span class="toc-text">Multi Modules</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#source-code-2"><span class="toc-number">1.4.1.</span> <span class="toc-text">Source Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#build-code-2"><span class="toc-number">1.4.2.</span> <span class="toc-text">Build Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#usage-2"><span class="toc-number">1.4.3.</span> <span class="toc-text">Usage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-2"><span class="toc-number">1.4.4.</span> <span class="toc-text">Test</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/Linux-Basic/UPBoard%20%E4%BC%98%E5%8C%96%E4%BF%AE%E5%A4%8D%E6%8C%87%E5%8D%97/" rel="bookmark" title="UPBoard 优化修复指南">UPBoard 优化修复指南</a></li><li><a href="/Linux-Basic/Linux%20Kernel%20Build/" rel="bookmark" title="Linux Kernel Build">Linux Kernel Build</a></li><li><a href="/Linux-Basic/Linux%20%E8%A7%A3%E5%AF%86%E2%80%94CPU%E5%88%A9%E7%94%A8%E7%8E%87/" rel="bookmark" title="Linux 解密—CPU利用率">Linux 解密—CPU利用率</a></li><li class="active"><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Simple%20Example/" rel="bookmark" title="Kernel Module — Simple Example">Kernel Module — Simple Example</a></li><li><a href="/Linux-Basic/devnull%20%E2%80%94%E2%80%94The%20Bit%20Bucket/" rel="bookmark" title="/dev/null ——The Bit Bucket 的故事">/dev/null ——The Bit Bucket 的故事</a></li><li><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic/" rel="bookmark" title="Kernel Module — Char Device  Driver">Kernel Module — Char Device Driver</a></li><li><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Char%20Device%20Basic%20II/" rel="bookmark" title="Kernel Module — Char Device Basic II">Kernel Module — Char Device Basic II</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Junwide Xiao" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Junwide Xiao</p><div class="description" itemprop="description">生活与技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">25</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">24</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2p1bndpZGU=" title="https:&#x2F;&#x2F;github.com&#x2F;junwide"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29t" title="https:&#x2F;&#x2F;www.zhihu.com"><i class="ic i-zhihu"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20=" title="https:&#x2F;&#x2F;weibo.com"><i class="ic i-weibo"></i></span> <a href="https://junwide.github.io/about" title="https:&#x2F;&#x2F;junwide.github.io&#x2F;about" class="item about"><i class="ic i-address-card"></i></a> <span class="exturl item email" data-url="bWFpbHRvOmp1bndpZGVAb3V0bG9vay5jb20=" title="mailto:junwide@outlook.com"><i class="ic i-envelope"></i></span> <span class="exturl item youtube" data-url="aHR0cHM6Ly95b3V0dWJlLmNvbQ==" title="https:&#x2F;&#x2F;youtube.com"><i class="ic i-youtube"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/Linux-Basic/Linux%20%E8%A7%A3%E5%AF%86%E2%80%94CPU%E5%88%A9%E7%94%A8%E7%8E%87/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/Linux-Basic/devnull%20%E2%80%94%E2%80%94The%20Bit%20Bucket/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/theme-shoka-doc/" title="分类于 博客">博客</a></div><span><a href="/theme-shoka-doc/display/" title="Step.3 界面显示">Step.3 界面显示</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/theme-shoka-doc/" title="分类于 博客">博客</a></div><span><a href="/theme-shoka-doc/theme-shoka-doc/" title="Hexo主题Shoka &amp; multi-markdown-it渲染器使用说明">Hexo主题Shoka & multi-markdown-it渲染器使用说明</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/other/" title="分类于 杂项">杂项</a></div><span><a href="/Other/Tech%20New%20Innovation/" title="Tech New Innovation">Tech New Innovation</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/UPBoard%20%E4%BC%98%E5%8C%96%E4%BF%AE%E5%A4%8D%E6%8C%87%E5%8D%97/" title="UPBoard 优化修复指南">UPBoard 优化修复指南</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Program/" title="分类于 编程技术">编程技术</a></div><span><a href="/Program/SWDevelopmentSkill/" title="SW Development Skill">SW Development Skill</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/embed-system/" title="分类于 嵌入式系统">嵌入式系统</a></div><span><a href="/embed-system/MCU%E4%B8%8E%E5%B5%8C%E5%85%A5%E5%BC%8F-%E5%9F%BA%E7%A1%80%E6%A6%82%E7%8E%871/" title="01| MCU与嵌入式:基础概率">01| MCU与嵌入式:基础概率</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/Linux%20%E8%A7%A3%E5%AF%86%E2%80%94CPU%E5%88%A9%E7%94%A8%E7%8E%87/" title="Linux 解密—CPU利用率">Linux 解密—CPU利用率</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/Linux%20Kernel%20Build/" title="Linux Kernel Build">Linux Kernel Build</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Simple%20Example/" title="Kernel Module — Simple Example">Kernel Module — Simple Example</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Latex%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F%E8%A1%A8%E8%BE%BE%E4%BB%A5%E5%8F%8A%E5%85%B6%E4%BB%96MD%E5%BD%A2%E5%BC%8F/" title="Latex数学公式表达以及其他MD形式">Latex数学公式表达以及其他MD形式</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Junwide Xiao @ Brain Home</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">138k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:11</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Linux-Basic/Kernel Module — Simple Example/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>