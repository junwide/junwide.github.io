<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="精神小伙" href="https://junwide.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="精神小伙" href="https://junwide.github.io/atom.xml"><link rel="alternate" type="application/json" title="精神小伙" href="https://junwide.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="C,C++,Make"><link rel="canonical" href="https://junwide.github.io/Program/SWDevelopmentSkill/"><title>SW Development Skill - 编程技术 | Brain Home = 精神小伙 = Tech.&Mem.</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">SW Development Skill</h1><div class="meta"><span class="item" title="创建时间：2021-01-22 12:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-01-22T12:00:00+08:00">2021-01-22</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>17k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>32 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Brain Home</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104528.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104136.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104554.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104513.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104627.jpg"></li><li class="item" data-background-image="https://gitee.com/junwide/blog/raw/master/20210418104434.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Program/" itemprop="item" rel="index" title="分类于 编程技术"><span itemprop="name">编程技术</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://junwide.github.io/Program/SWDevelopmentSkill/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Junwide Xiao"><meta itemprop="description" content="Tech.&Mem., 生活与技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="精神小伙"></span><div class="body md" itemprop="articleBody"><h1 id="sw-development-skill"><a class="anchor" href="#sw-development-skill">#</a> SW Development Skill</h1><h2 id="1-makefile"><a class="anchor" href="#1-makefile">#</a> 1. Makefile</h2><h3 id="11-makefile简介"><a class="anchor" href="#11-makefile简介">#</a> 1.1 Makefile 简介</h3><p><strong>用途：</strong></p><ul><li>描述整个工程的编译，链接的规则</li><li>软件项目的自动化编译</li></ul><p><strong>工作过程：</strong></p><ul><li>解析 Makefile 命令，建立依赖关系图</li><li>命令运行阶段</li></ul><h3 id="12-makefile中的概念"><a class="anchor" href="#12-makefile中的概念">#</a> 1.2 Makefile 中的概念</h3><p><strong>命令基本构成：</strong></p><ul><li>目标</li><li>目标依赖</li><li>命令</li></ul><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#目标：目标依赖</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#[tab] 命令</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token symbol">main</span><span class="token punctuation">:</span> a.o</pre></td></tr><tr><td data-num="4"></td><td><pre>	gcc -o main a.o</pre></td></tr></table></figure><blockquote><p>Tip：</p><ol><li>命令开头必须摇头 Tab</li><li>一个规则可以没有目标依赖，仅仅描述<strong>某种操作</strong></li><li>一个规则可以没有命令，仅仅描述<strong>依赖关系</strong></li><li>一个规则必须有一个目标</li></ol></blockquote><p><strong>目标：</strong></p><ul><li><p>默认目标</p><ul><li>一个 Makefile 里面可以有多个目标</li><li>一般选择第一个<strong>默认目标</strong></li></ul></li><li><p>多目标</p><ul><li>一个规则中可以有多个目标</li><li>多个目标具有相同的生成命令和依赖文件</li></ul></li><li><p>多规则目标</p><ul><li>多个规则可以是同一个目标</li><li>Make 在解析中，会将多个规则的依赖文件合并</li></ul></li><li><p>伪目标</p><ul><li>并不是一个真正的文件名，可以看成是一个标签，用 <code>.PONHY</code> 申明</li><li>无依赖，相比一般文件不会去重新生成和执行</li><li>可以无条件执行</li></ul></li></ul><p><strong>文件时间戳：</strong></p><ul><li>根据时间戳来判断目标依赖文件是否更新</li><li>若所有文件没有编译过，则对所有文件编译，生成可执行程序</li><li>在上次 make 之后修改过的 <code>.c</code> 文件，会被重新编译</li><li>在上次 make 之后修改过的 <code>.h</code> 文件，依赖此头文件的会被重新编译</li></ul><p><strong>自动产生依赖：</strong></p><p><code>GCC -M</code> 自动生成该文件要依赖的文件</p><p><strong>命令：</strong></p><ul><li>每一个命令，make 都会开一个进程</li><li>每条命令执行完，<strong>make 会检查返回的状态码</strong><ul><li>返回成功：继续下一个命令</li><li>返回失败：终止当前规则退出</li></ul></li></ul><h3 id="13-makefile的语法"><a class="anchor" href="#13-makefile的语法">#</a> 1.3 Makefile 的语法</h3><p><strong>变量：</strong></p><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#定义：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>CC <span class="token operator">=</span> gcc</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#赋值：</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#追加赋值： += </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#条件赋值： ?=</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#变量引用</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span>  <span class="token variable">$</span><span class="token punctuation">&#123;</span>CC<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#立即展开变量： 在解析阶段 直接赋值 常量字符串  (一般用在目标依赖)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>ARCH <span class="token operator">:=</span> <span class="token string">'arm64'</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#延迟展开变量： 在运行阶段 实际使用变量时 再进行求值 (一般用在命令中)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>ARCH <span class="token operator">=</span> <span class="token string">'arm64'</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#自动变量 目标 $@ 所有目标依赖 $^ 第一个依赖 $&lt;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	gcc -o <span class="token variable">$@</span> <span class="token variable">$^</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#系统环境变量</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#CFLAG</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#SHELL</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#MAKE</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">#对所有 makefile 都有效，在 make 开始运行时被载入到 Makefile 文件中。若 Makfile 中定义</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">#了同名变量，将会被覆盖，在命令行中传递同名，同样被覆盖。</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#变量传递 多目录下递归执行</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -c subdir</pre></td></tr><tr><td data-num="27"></td><td><pre>cd subdir &amp;&amp; <span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">#通过 export 传递</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#通过命令行传递</span></pre></td></tr></table></figure><p><strong>条件执行：</strong></p><ul><li><code>ifeq else endif</code></li><li><code>ifneq</code></li></ul><blockquote><p>条件语句从 <code>ifeq</code> 开始，括号和关键字用空格隔开</p></blockquote><p><strong>函数：</strong></p><p><strong>常用函数：</strong></p><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#打印 warning 信息 </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#返回： 打印的 & lt;text...> 变量</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">warning</span> &lt;text...><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#打印 error 信息 </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#返回： 打印的 & lt;text...> 变量，并且 exit</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">error</span> &lt;text...><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="14-依赖关系树"><a class="anchor" href="#14-依赖关系树">#</a> 1.4 依赖关系树</h3><p><strong>依赖关系树的生命周期：</strong></p><ul><li>解析阶段载入内存</li><li>运行阶段根据其进行编译，根据时间戳生成文件</li><li>新文件添加，减少会动态改变依赖关系树</li></ul><h3 id="15-执行过程"><a class="anchor" href="#15-执行过程">#</a> 1.5 执行过程</h3><ol><li>进入编译目录</li><li>执行 make</li><li>依赖关系解析<ul><li>解析 Makefile 建立依赖关系图</li><li>控制解析过程：引入 Makefile，变量展开，条件执行</li><li>生成依赖关系树</li></ul></li><li>命令执行阶段<ul><li>将解析生成的依赖关系树加载到内存</li><li>依照依赖关系，按顺序生成这些文件</li><li>再次编译 Make 会检查文件的时间戳，判断是否过期<ul><li>若无过期，退出</li><li>若有更新，则依赖该文件的所有依赖关系上的目标重新更新，编译生成</li></ul></li></ul></li></ol><p><strong>状态码：</strong></p><p>0： 成功执行</p><p>1： 运行错误，返回 1</p><h3 id="16-隐含规则"><a class="anchor" href="#16-隐含规则">#</a> 1.6 隐含规则</h3><p><strong>规则：</strong></p><ol><li><p>默认 <code>.c</code> 编译生成对应的 <code>.o</code> 目标文件</p></li><li><p>取消隐含规则： 使用 <code>-r</code> 或者 <code>-R</code></p><p>eg: <code>make -r</code></p></li></ol><p><strong>命令变量：</strong></p><ul><li>CC：编译程序，默认 cc</li><li>AS：汇编程序，默认 as</li><li>CXX：C<ins> 编译程序，默认 g</ins></li><li>AR：函数库打包程序，默认是 ar</li></ul><p><strong>命令参数变量：</strong></p><ul><li>CFLAGS：执行 CC 编译器的命令参数</li><li>CXXFLAGS：执行 g++ 编译器的命令参数</li><li>ASFLAGS：执行 as 编译器的命令参数</li><li>ARFLAGS：执行 ar 编译器的命令参数</li></ul><h3 id="17-代码示例"><a class="anchor" href="#17-代码示例">#</a> 1.7 代码示例</h3><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre>LOCAL_PATH<span class="token operator">:=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">call</span> my-dir<span class="token punctuation">)</span> <span class="token comment">#定义模块当前路径</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>CLEAR_VARS<span class="token punctuation">)</span>  <span class="token comment">#清空当前环境变量</span></pre></td></tr><tr><td data-num="3"></td><td><pre>LOCAL_xxx <span class="token operator">:=</span>xxx       <span class="token comment">#引入头文件</span></pre></td></tr><tr><td data-num="4"></td><td><pre>LOCAL_MODULE <span class="token operator">:=</span>hello  <span class="token comment">#编译生成的文件名</span></pre></td></tr><tr><td data-num="5"></td><td><pre>LOCAL_SRC_FILES <span class="token operator">:=</span>hello.c <span class="token comment">#编译需要的源码</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token variable">$</span><span class="token punctuation">(</span>BUILD_EXECUTABLE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#编译生成文件的类型</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#LOCAL_MODULE_CLASS,JAVA_LIBRARIES</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#APPS,SHARED_LIBRARIES</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#EXECUTABLES,ETCinclude</span></pre></td></tr></table></figure><p><strong>编译动态库</strong></p><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre>LOCAL_PATH<span class="token operator">:=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">call</span> my-dir<span class="token punctuation">)</span> <span class="token comment">#定义模块当前路径</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>CLEAR_VARS<span class="token punctuation">)</span>  <span class="token comment">#清空当前环境变量</span></pre></td></tr><tr><td data-num="3"></td><td><pre>LOCAL_MODULE <span class="token operator">:=</span>libhello  <span class="token comment">#编译生成的文件名</span></pre></td></tr><tr><td data-num="4"></td><td><pre>LOCAL_CFLAGS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>L_CFLAGS<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>LOCAL_SRC_FILES <span class="token operator">=</span> hello.c</pre></td></tr><tr><td data-num="6"></td><td><pre>LOCAL_C_INCLUDES <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>INCLUDES<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>LOCAL_SHARED_LIBRARIES <span class="token operator">:=</span> libcutils</pre></td></tr><tr><td data-num="8"></td><td><pre>LOCAL_COPY_HEADERS_TO <span class="token operator">:=</span> libhello</pre></td></tr><tr><td data-num="9"></td><td><pre>LOCAL_COPY_HEADERS <span class="token operator">:=</span> hello.h</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#编译动态库 BUILD_SHARED_LIBRARY</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_SHARED_LIBRARY<span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>编译静态库</strong></p><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre>LOCAL_PATH<span class="token operator">:=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">call</span> my-dir<span class="token punctuation">)</span> <span class="token comment">#定义模块当前路径</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>CLEAR_VARS<span class="token punctuation">)</span>  <span class="token comment">#清空当前环境变量</span></pre></td></tr><tr><td data-num="3"></td><td><pre>LOCAL_MODULE <span class="token operator">:=</span>libhello  <span class="token comment">#编译生成的文件名</span></pre></td></tr><tr><td data-num="4"></td><td><pre>LOCAL_CFLAGS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>L_CFLAGS<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>LOCAL_SRC_FILES <span class="token operator">=</span> hello.c</pre></td></tr><tr><td data-num="6"></td><td><pre>LOCAL_C_INCLUDES <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>INCLUDES<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>LOCAL_SHARED_LIBRARIES <span class="token operator">:=</span> libcutils  <span class="token comment">#这一行不知有么有错误</span></pre></td></tr><tr><td data-num="8"></td><td><pre>LOCAL_COPY_HEADERS_TO <span class="token operator">:=</span> libhello</pre></td></tr><tr><td data-num="9"></td><td><pre>LOCAL_COPY_HEADERS <span class="token operator">:=</span> hello.h</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#编译动态库 BUILD_STATIC_LIBRARY</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_STATIC_LIBRARY<span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>引用库</strong></p><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#引用静态库</span></pre></td></tr><tr><td data-num="2"></td><td><pre>LOCAL_STATIC_LIBRAIES <span class="token operator">+=</span> libxxxx</pre></td></tr><tr><td data-num="3"></td><td><pre>LOCAL_STATIC_LIBRAIES <span class="token operator">:=</span> \</pre></td></tr><tr><td data-num="4"></td><td><pre>                       libxxx2\</pre></td></tr><tr><td data-num="5"></td><td><pre>                       libxxx \</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#引用动态库</span></pre></td></tr><tr><td data-num="8"></td><td><pre>LOCAL_SHARED_LIBRARIES <span class="token operator">+=</span> libxxx</pre></td></tr><tr><td data-num="9"></td><td><pre>LOCAL_SHARED_LIBRARIES <span class="token operator">:=</span> liblog libnativehelper libGLESv2</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#引用第三方库文件</span></pre></td></tr><tr><td data-num="12"></td><td><pre>LOCAL_LDFLAGS <span class="token operator">:=</span> -L/PATH-Lxxx</pre></td></tr><tr><td data-num="13"></td><td><pre>LOCAL_LDFLAGS <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>LOCAL_PATH<span class="token punctuation">)</span>/lib/libtest.a</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#引用第三方头文件</span></pre></td></tr><tr><td data-num="16"></td><td><pre>LOCAL_C_INCLUDE <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>INCLUDES<span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="2-c-advance"><a class="anchor" href="#2-c-advance">#</a> 2. C Advance</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>Source <span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">.</span>cpp <span class="token punctuation">.</span>c <span class="token punctuation">.</span>h<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                         <span class="token operator">|</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                         <span class="token operator">|</span> eg<span class="token operator">:</span> gcc <span class="token operator">-</span>E test<span class="token punctuation">.</span>c <span class="token operator">-</span>o test<span class="token punctuation">.</span>i</pre></td></tr><tr><td data-num="4"></td><td><pre>                                         V Step<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">preprocessor</span> <span class="token punctuation">(</span>cpp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                   Preprocesing</pre></td></tr><tr><td data-num="6"></td><td><pre>                                         <span class="token operator">|</span></pre></td></tr><tr><td data-num="7"></td><td><pre>           include header<span class="token punctuation">,</span>Expand Macro   <span class="token operator">|</span> eg<span class="token operator">:</span> gcc <span class="token operator">-</span>S <span class="token operator">-</span>fno<span class="token operator">-</span>builtin test<span class="token punctuation">.</span>i <span class="token operator">-</span>o  test<span class="token punctuation">.</span>s</pre></td></tr><tr><td data-num="8"></td><td><pre>                                         V Step<span class="token operator">:</span> <span class="token number">2</span><span class="token operator">:</span><span class="token function">Compiler</span> <span class="token punctuation">(</span>gcc<span class="token punctuation">,</span>g<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                   Compilation</pre></td></tr><tr><td data-num="10"></td><td><pre>                                         <span class="token operator">|</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                   Assembly Code <span class="token punctuation">.</span>S      <span class="token operator">|</span> eg<span class="token operator">:</span> gcc <span class="token operator">-</span>c test<span class="token punctuation">.</span>s <span class="token operator">-</span>o test<span class="token punctuation">.</span>o</pre></td></tr><tr><td data-num="12"></td><td><pre>                                         V Step<span class="token operator">:</span> <span class="token number">3</span><span class="token operator">:</span><span class="token function">Assembly</span> <span class="token punctuation">(</span>as<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                                      Assemble</pre></td></tr><tr><td data-num="14"></td><td><pre>                                         <span class="token operator">|</span></pre></td></tr><tr><td data-num="15"></td><td><pre>               Machine <span class="token function">Code</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>o <span class="token punctuation">.</span>obj<span class="token punctuation">)</span>    <span class="token operator">|</span> eg<span class="token operator">:</span> gcc test<span class="token punctuation">.</span>o <span class="token operator">-</span>o test</pre></td></tr><tr><td data-num="16"></td><td><pre>                                         V Step<span class="token operator">:</span> <span class="token number">4</span><span class="token operator">:</span><span class="token function">Linker</span><span class="token punctuation">(</span>ld<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                                      Linking</pre></td></tr><tr><td data-num="18"></td><td><pre>                                         <span class="token operator">|</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                                         V</pre></td></tr><tr><td data-num="20"></td><td><pre>                             Executable Machine <span class="token function">Code</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>exe<span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="21-可执行文件结构"><a class="anchor" href="#21-可执行文件结构">#</a> 2.1 可执行文件结构</h3><table><thead><tr><th style="text-align:center">段</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">.text</td><td style="text-align:center">存放可执行的<strong>代码指令</strong> 和<strong>常量</strong> <strong>只读</strong>属性 防止程序被意外篡改 大小在运行前已经确定</td></tr><tr><td style="text-align:center">.data</td><td style="text-align:center">程序中明确被<strong>初始化</strong>的<strong>全局变量</strong>，静态变量（全局 / 局部静态变量）</td></tr><tr><td style="text-align:center">.bss</td><td style="text-align:center">未初始化全局变量和未初始化静态变量 （或者初始化为 0）</td></tr><tr><td style="text-align:center">init / Table</td><td style="text-align:center"></td></tr></tbody></table><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>file1<span class="token punctuation">.</span>obj</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">|</span>  <span class="token punctuation">.</span>bss   <span class="token operator">|</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">|</span>         <span class="token operator">|</span>                         Executable objecy moudele              Memory Map</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">|</span>  <span class="token punctuation">.</span>text  <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>                          <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>                    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>    <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token function">bss</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span> <span class="token operator">|</span>                    <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">|</span>         <span class="token operator">|</span>    <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token function">bss</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span> <span class="token operator">|</span>                    <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">|</span>  <span class="token punctuation">.</span>data  <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>                     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>                    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>   <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token operator">|</span>                    <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">|</span>         <span class="token operator">|</span>    <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token operator">|</span>                    <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">|</span>   init  <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>                   <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>                    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>   <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token operator">|</span>                    <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="15"></td><td><pre>               <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token operator">|</span>                    <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="16"></td><td><pre>               <span class="token operator">|</span>                          <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>                    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="17"></td><td><pre>file2<span class="token punctuation">.</span>obj      <span class="token operator">|</span>                          <span class="token operator">|</span>  init    <span class="token operator">|</span>                    <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>    <span class="token operator">|</span>                          <span class="token operator">|</span>  Tables  <span class="token operator">|</span>                    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token operator">|</span>         <span class="token operator">|</span>    <span class="token operator">|</span>                          <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>                    <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token operator">|</span>  <span class="token punctuation">.</span>bss   <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>                                                     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>    <span class="token operator">|</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token operator">|</span>         <span class="token operator">|</span>    <span class="token operator">|</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token operator">|</span>  <span class="token punctuation">.</span>text  <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token operator">|</span>  <span class="token punctuation">.</span>data  <span class="token operator">|</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token operator">|</span> Tables  <span class="token operator">|</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span></pre></td></tr></table></figure><h3 id="22-进程的结构"><a class="anchor" href="#22-进程的结构">#</a> 2.2 进程的结构</h3><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>high  addr   ____________________</pre></td></tr><tr><td data-num="2"></td><td><pre>                                      <span class="token operator">|</span> command<span class="token operator">-</span>line arg <span class="token operator">|</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>                                      <span class="token operator">|</span>and env variables <span class="token operator">|</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                      ____________________</pre></td></tr><tr><td data-num="5"></td><td><pre>                                      <span class="token operator">|</span>     stack        <span class="token operator">|</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                                      <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                                      <span class="token operator">|</span>        <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                                      <span class="token operator">|</span>        V         <span class="token operator">|</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                      <span class="token operator">|</span>                  <span class="token operator">|</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                                      <span class="token operator">|</span>                  <span class="token operator">|</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                                      <span class="token operator">|</span>                  <span class="token operator">|</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                                      <span class="token operator">|</span>                  <span class="token operator">|</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                                      <span class="token operator">|</span>        <span class="token operator">^</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                                      <span class="token operator">|</span>        <span class="token operator">|</span>         <span class="token operator">|</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                                      <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                                      <span class="token operator">|</span>      heap        <span class="token operator">|</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                                      ____________________</pre></td></tr><tr><td data-num="18"></td><td><pre>                                      <span class="token operator">|</span>      <span class="token punctuation">.</span>bss        <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">></span>initialized to zero by exec</pre></td></tr><tr><td data-num="19"></td><td><pre>                                      ____________________    </pre></td></tr><tr><td data-num="20"></td><td><pre>                                      <span class="token operator">|</span> initialized data <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                                      ____________________    <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">-></span> read from program file by exec</pre></td></tr><tr><td data-num="22"></td><td><pre>                                      <span class="token operator">|</span>      text        <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                           low  addr  ____________________</pre></td></tr></table></figure><h3 id="23-宏函数"><a class="anchor" href="#23-宏函数">#</a> 2.3 宏函数</h3><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SQR</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x<span class="token operator">*</span>x</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// SQR(2) 2*2 = 4</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// SQR(2+1) 2+1*2+1 =5</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 替换法则：直接进行替换而不会行进行计算</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SQR</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// SQR(2+1) (2+1) * (2+1)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ADD</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//ADD(1,2)  1+2 = 3</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">//ADD(1,2) * ADD(2,3)  1 + 2 * 2 + 3 =8</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// 一样的问题。所以保证结果必须加多一层括号</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ADD</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">//ADD(1,2) * ADD(2,3)  (1 + 2) * (2 + 3) = 15</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">/* 使用包含多语句防止错误 */</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_my_lock</span><span class="token expression"><span class="token punctuation">(</span>test<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>           </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>               <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token operator">-></span>lock_enable<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                  <span class="token expression"><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pcm_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="20"></td><td><pre>               <span class="token expression"><span class="token function">PROCESS</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">_my_lock</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">// ARRAY_SIZE</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ARRAY_SIZE</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">//container_of  // 内存对齐</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">test_macro</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">int</span> a<span class="token punctuation">;</span>            <span class="token comment">//addr:0x84046b0</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">char</span> b<span class="token punctuation">;</span>           <span class="token comment">//addr:0x84046b4</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>c<span class="token punctuation">;</span>          <span class="token comment">//addr:0x84046b8</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">int</span> <span class="token operator">*</span>c<span class="token punctuation">;</span>           <span class="token comment">//addr:0x84046c0</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">offsetof</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span>member<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token operator">-></span>member<span class="token punctuation">)</span> </span><span class="token comment">// 拿到绝对偏移</span></span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_container_of</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>type<span class="token punctuation">,</span>member<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>	               </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="42"></td><td><pre>                 <span class="token expression"><span class="token keyword">void</span> <span class="token operator">*</span>_mptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>               </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_mptr <span class="token operator">-</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>member<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">test_macro</span> <span class="token operator">*</span>test <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token class-name">size_t</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>test<span class="token operator">-></span>d<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>test <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">test_macro</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="51"></td><td><pre>test <span class="token operator">=</span> <span class="token function">_container_of</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">test_marco</span><span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr></table></figure><blockquote><p>Tip:</p><ol><li><p>关于 <code>(type*)0</code> 是因为没有一个实例，所以使用一个 NULL 指针，这个指针为了能够引用实例化后的成员，而 NULL 是 0x000000</p><p>然后就指导 <code>member</code> 就能得到绝对的偏移值。</p></li><li><p>直接使用 （type*）-&gt; member 是错误的没有对象</p></li></ol></blockquote><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//list</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  		<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>next<span class="token punctuation">,</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>   </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">student</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> number<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">int</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_HEAD_INIT</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_HEAD</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">list_head</span> name <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">INIT_LIST_HEAD</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token keyword">do</span><span class="token punctuation">&#123;</span>  </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token operator">-></span>next <span class="token operator">=</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token expression"><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">list_entry</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> type<span class="token punctuation">,</span> member<span class="token punctuation">)</span> \  \<span class="token operator">*</span>获得list的入口地址<span class="token operator">*</span></span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token expression"><span class="token punctuation">&#123;</span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-></span>member<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">list_for_each</span><span class="token expression"><span class="token punctuation">(</span>pos<span class="token punctuation">,</span>head<span class="token punctuation">)</span>  \   \<span class="token operator">*</span> 常用在循环list<span class="token operator">*</span></span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>     <span class="token expression"><span class="token keyword">for</span> <span class="token punctuation">(</span>pos <span class="token operator">=</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token operator">-></span>next<span class="token punctuation">;</span> pos <span class="token operator">!=</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span> pos <span class="token operator">=</span> pos<span class="token operator">-></span>next<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>     </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">list_for_each_safe</span><span class="token expression"><span class="token punctuation">(</span>pos<span class="token punctuation">,</span>n <span class="token punctuation">,</span> head<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>         <span class="token expression"><span class="token keyword">for</span> <span class="token punctuation">(</span>pos <span class="token operator">=</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token operator">-></span>next<span class="token punctuation">,</span> n <span class="token operator">=</span> pos<span class="token operator">-></span>next<span class="token punctuation">;</span> pos <span class="token operator">!=</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                   <span class="token expression">pos <span class="token operator">=</span> n<span class="token punctuation">,</span> n <span class="token operator">=</span> pos<span class="token operator">-></span>next<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>     </pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">list_for_each_entry</span><span class="token expression"><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> head<span class="token punctuation">,</span> member<span class="token punctuation">)</span>  </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>         <span class="token expression"><span class="token keyword">for</span><span class="token punctuation">(</span>pos <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token operator">*</span>pos<span class="token punctuation">)</span><span class="token punctuation">,</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                 <span class="token expression"><span class="token operator">&amp;</span>pos<span class="token operator">-></span>member <span class="token operator">!=</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                 <span class="token expression">pos <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>pos<span class="token operator">-></span>member<span class="token punctuation">.</span>next<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token operator">*</span>pos<span class="token punctuation">)</span><span class="token punctuation">,</span> member<span class="token punctuation">)</span></span></pre></td></tr></table></figure><p><strong>内存操作</strong></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span>p1<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span>p2<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">alloca</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="24-practical"><a class="anchor" href="#24-practical">#</a> 2.4 Practical</h3><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">INIT_LIST_HEAD</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token keyword">do</span><span class="token punctuation">&#123;</span></span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token operator">-></span>next <span class="token operator">=</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token expression"><span class="token punctuation">&#125;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">list_entry</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> type <span class="token punctuation">,</span> member<span class="token punctuation">)</span></span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-></span> member<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">list_for_each</span><span class="token expression"><span class="token punctuation">(</span>pos<span class="token punctuation">,</span>head<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token expression"><span class="token keyword">for</span> <span class="token punctuation">(</span>pos <span class="token operator">=</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token operator">-></span>next<span class="token punctuation">,</span> n <span class="token operator">=</span> pos<span class="token operator">-></span>next<span class="token punctuation">;</span> pos <span class="token operator">!=</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>         <span class="token expression">pos <span class="token operator">=</span> n<span class="token punctuation">,</span> n <span class="token operator">=</span> pos<span class="token operator">-></span>head<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>        </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">list_head</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>next<span class="token punctuation">,</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">myqueue</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> my_list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">my_element</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">int</span> vale</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span>my_element<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">myqueue</span> <span class="token operator">*</span><span class="token function">queue_init</span><span class="token punctuation">(</span><span class="token keyword">int</span> element_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_uninit</span><span class="token punctuation">(</span><span class="token keyword">struct</span>  <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_empty</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_size</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_front</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_back</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_push</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_pop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">myqueue</span> <span class="token operator">*</span><span class="token function">queue_init</span><span class="token punctuation">(</span><span class="token keyword">int</span> element_size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">int</span> size <span class="token operator">=</span> element_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">myqueue</span> <span class="token operator">*</span>my_init_quenu <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>head <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>my_init_quenu<span class="token operator">-></span>my_list<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    my_element <span class="token operator">*</span>node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size <span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        node <span class="token operator">=</span> <span class="token punctuation">(</span>my_element<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>my_element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        node<span class="token operator">-></span>vale <span class="token operator">=</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        node<span class="token operator">-></span>node<span class="token punctuation">.</span>next <span class="token operator">=</span> head<span class="token operator">-></span>next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        head<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token operator">-></span>node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        head<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token operator">-></span>node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        node<span class="token operator">-></span>node<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        </pre></td></tr><tr><td data-num="54"></td><td><pre>        node <span class="token operator">=</span> null<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">return</span> my_init_quenu<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_uninit</span><span class="token punctuation">(</span><span class="token keyword">struct</span>  <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span> lisptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    my_element <span class="token operator">*</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token function">list_for_each</span><span class="token punctuation">(</span>lisptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>q<span class="token operator">-></span>my_list<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        node <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>lisptr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_element</span> <span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        lisptr <span class="token operator">=</span> lisptr<span class="token operator">-></span>next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"free node \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token function">free</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token function">node</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_empty</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">queue_size</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_size</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next <span class="token operator">==</span> q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">unsigned</span>  <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span> ptr <span class="token operator">=</span>  <span class="token operator">&amp;</span><span class="token punctuation">(</span>q<span class="token operator">-></span>my_list<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">int</span> <span class="token keyword">const</span> <span class="token operator">*</span> ptr_addr <span class="token operator">=</span> q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>prev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>ptr<span class="token operator">-></span>next <span class="token operator">!=</span> ptr_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        size<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        ptr <span class="token operator">=</span> ptr<span class="token operator">-></span>next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">return</span> size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_front</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    my_element <span class="token operator">*</span> node <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_element</span><span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Top value: %d"</span><span class="token punctuation">,</span>node<span class="token operator">-></span>vale<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_back</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    my_element <span class="token operator">*</span> node <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>prev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_element</span><span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Rear value: %d"</span><span class="token punctuation">,</span>node<span class="token operator">-></span>vale<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_push</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    my_element <span class="token operator">*</span> new_node <span class="token operator">=</span> <span class="token punctuation">(</span>my_element<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>my_element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>new_node<span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    new_node<span class="token operator">-></span>vale <span class="token operator">=</span> value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    new_node<span class="token operator">-></span>node<span class="token punctuation">.</span>next <span class="token operator">=</span> q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>new_node<span class="token operator">-></span>node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token operator">&amp;</span>new_node<span class="token operator">-></span>node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    new_node<span class="token operator">-></span>node<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>q<span class="token operator">-></span>my_list<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token keyword">int</span> <span class="token function">queue_pop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">myqueue</span><span class="token operator">*</span>q<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    my_element <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_element</span><span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next<span class="token operator">-></span>prev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token operator">-></span>my_list<span class="token punctuation">.</span>next<span class="token operator">-></span>next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token function">free</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="3-c-advance"><a class="anchor" href="#3-c-advance">#</a> 3. C++ Advance</h2><h3 id="31-函数相关"><a class="anchor" href="#31-函数相关">#</a> 3.1 函数相关</h3><p><strong>引用和指针</strong></p><p>引用本质上也是使用指针实现的，但是两者还是有许多不同。</p><ul><li>引用初始化必须赋值</li><li>引用使用更安全</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">duplicate_</span> <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  a<span class="token operator">*=</span><span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">void</span> <span class="token function">duplicate</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> a<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  a<span class="token operator">*=</span><span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">int</span> y<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">duplicate_</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token function">duplicate</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"x="</span> <span class="token operator">&lt;&lt;</span> x<span class="token punctuation">;</span> <span class="token comment">//1</span></pre></td></tr><tr><td data-num="16"></td><td><pre>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"y="</span> <span class="token operator">&lt;&lt;</span> y<span class="token punctuation">;</span> <span class="token comment">//2</span></pre></td></tr></table></figure><p><strong>CONST</strong></p><ul><li>当函数参数是较复杂数据类型时，值传递存在数据复制，效率较低</li><li>引用传递效率高，但是有参数值被函数篡改的风险</li><li>效率高，参数无法被修改</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>string <span class="token function">combine</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span> a<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 效率高，参数无法被修改</span></pre></td></tr></table></figure><p><strong>缺省参数</strong></p><p>能够给函数默认的初值</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    r <span class="token operator">=</span> a <span class="token operator">/</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>cout<span class="token operator">&lt;&lt;</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>  <span class="token comment">//6</span></pre></td></tr><tr><td data-num="9"></td><td><pre>cout<span class="token operator">&lt;&lt;</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//5</span></pre></td></tr></table></figure><p><strong>内联函数</strong></p><ul><li><p>函数调用的开销 → 内联函数</p></li><li><p>效率取向</p></li><li><p>效率更高，体积更大</p></li><li><p>无函数调用，而是将代码在调用处展开，与 compiler 有关</p></li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">inline</span> string <span class="token function">combine</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span> a<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">return</span> a<span class="token operator">+</span>b</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>重载</strong></p><p>同名不同参函数实现</p><ul><li><p>主要实现的原理是：</p><p>主要是通过参数类型来标识函数，所以参数不同函数名同可以，参数同，返回类型不同就不可以</p></li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// c++ code</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">float</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">float</span> a<span class="token punctuation">,</span> <span class="token keyword">float</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">double</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">float</span> a<span class="token punctuation">,</span> <span class="token keyword">float</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//NO</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// c++ code</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">float</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">float</span> a<span class="token punctuation">,</span> <span class="token keyword">float</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">double</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">double</span> a<span class="token punctuation">,</span> <span class="token keyword">double</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="32-类"><a class="anchor" href="#32-类">#</a> 3.2 类</h3><h4 id="类的定义"><a class="anchor" href="#类的定义">#</a> 类的定义</h4><ul><li><p>类似 C 语言的 struct</p></li><li><p>成员不仅有变量，还有函数</p><ul><li>成员变量</li><li>成员函数</li></ul></li><li><p>某些成员只有特定函数能访问</p><ul><li>公共项 (public)</li><li>隐藏项 (private)</li></ul></li><li><p>允许用户重定义功能</p></li><li><p>class 扩展了基础数据类型</p><ul><li>类可视为一种数据类型</li><li>类的实例即为该种数据类型所定义的变量</li><li>类实例中的成员变量可以是单独拷贝也可以共享</li></ul></li></ul><h4 id="构造析构函数"><a class="anchor" href="#构造析构函数">#</a> 构造 / 析构函数</h4><ul><li><p>功能</p><ul><li>成员变量初始化</li><li>调用</li></ul></li><li><p>销毁</p></li><li><p>创建</p><ul><li>类的实例时，自动调用</li></ul></li><li><p>类生命周期结束，自动销毁</p></li><li><p>命名</p><ul><li>构造函数名与类名相同，且无返回</li><li>析构函数名和类名相同，但多加一个 <code>~</code></li></ul></li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Rect</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">int</span> width<span class="token punctuation">,</span> high<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    pubilc<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    	<span class="token function">Rect</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    	<span class="token operator">~</span><span class="token function">Rect</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    	<span class="token keyword">int</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span>width<span class="token operator">*</span>heigh<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">Rect</span><span class="token operator">::</span><span class="token function">Rect</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    width <span class="token operator">=</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    heigh <span class="token operator">=</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>成员变量初始化</strong></p><p>方式一：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Rect</span><span class="token operator">::</span><span class="token function">Rect</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    width <span class="token operator">=</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    heigh <span class="token operator">=</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>方式二：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Rect</span><span class="token operator">::</span><span class="token function">Rect</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">width</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">heigth</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Tip：</p><ul><li>若是对基础数据类型，两种方式差别不大</li><li>若是拓展类型，或者时自定义的类，方式二更高效</li></ul></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Circle</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">double</span> radius<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    pubilc<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    	<span class="token function">Circle</span><span class="token punctuation">(</span><span class="token keyword">double</span> r<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">radius</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    	<span class="token operator">~</span><span class="token function">Circle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    	<span class="token keyword">double</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> radius <span class="token operator">*</span> radius <span class="token operator">*</span> <span class="token number">3.1415</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Cylinder</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    Circle base<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">double</span> hegih<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    pubilc<span class="token operator">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    	<span class="token function">Cylinder</span><span class="token punctuation">(</span><span class="token keyword">double</span> r<span class="token punctuation">,</span><span class="token keyword">double</span> h<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">base</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">heigh</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    	<span class="token operator">~</span><span class="token function">Cylinder</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    	<span class="token keyword">double</span> <span class="token function">volume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> base<span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> heigh<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="33-运算符重载"><a class="anchor" href="#33-运算符重载">#</a> 3.3 运算符重载</h3><p>定义： 通过定义运算符的函数来实现重载</p><p><code>type operator sign (parameters) &#123;&#125;</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">CVetor</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Public<span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    	<span class="token keyword">int</span> x<span class="token punctuation">,</span>y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    	<span class="token function">CVector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    	<span class="token function">CVector</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">x</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">y</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    	Cvector <span class="token keyword">operator</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">const</span> CVector<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>Cvector Cvector<span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">const</span> CVector <span class="token operator">&amp;</span> param<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    Cvector temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    temp<span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">+</span> param<span class="token punctuation">.</span>x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    temp<span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">+</span> param<span class="token punctuation">.</span>y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>非成员函数实现</strong></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>Cvector <span class="token keyword">operator</span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">const</span> CVector <span class="token operator">&amp;</span> param<span class="token punctuation">,</span><span class="token keyword">const</span> CVector <span class="token operator">&amp;</span> param_2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Cvector temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    temp<span class="token punctuation">.</span>x <span class="token operator">=</span> param_2<span class="token punctuation">.</span>x <span class="token operator">+</span> param<span class="token punctuation">.</span>x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    temp<span class="token punctuation">.</span>y <span class="token operator">=</span> param_2<span class="token punctuation">.</span>y <span class="token operator">+</span> param<span class="token punctuation">.</span>y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="34-this和成员修饰"><a class="anchor" href="#34-this和成员修饰">#</a> 3.4 this 和成员修饰</h3><ul><li>this 指针指向正在执行的类实体</li><li>成员函数通过 this 指针，访问到实体成员</li></ul><p>用途：</p><ol><li>可以检查函数参数是否时对象自己</li><li>在运行符 opreator = 重载的成员函数中将对象自己作为返回值输出</li></ol><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Rect</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">int</span> width<span class="token punctuation">,</span> high<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    pubilc<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    	<span class="token function">Rect</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    	<span class="token operator">~</span><span class="token function">Rect</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    	<span class="token keyword">int</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span>；</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name">Rect</span><span class="token operator">::</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>high<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>检查是否是自己</strong></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">Rect</span><span class="token operator">::</span><span class="token function">isitme</span><span class="token punctuation">(</span>Rect <span class="token operator">&amp;</span> param<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>param <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>将自己作为返回值输出</strong></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>Cvector<span class="token operator">&amp;</span> Cvector<span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> CVector <span class="token operator">&amp;</span> param<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    x <span class="token operator">=</span> param<span class="token punctuation">.</span>x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    y <span class="token operator">=</span> param<span class="token punctuation">.</span>y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>成员函数修饰</strong></p><ul><li><p>Static</p><ul><li>静态成员属于整个类，而不是某个<strong>具体的实例对象</strong></li><li>静态成员变量只存储一份，供全体对象使用</li></ul><p>&lt;img src=&quot;C:%5CUsers%5Cjunwi%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200726001952805.png&quot; alt=&quot;image-20200726001952805&quot; style=&quot;zoom: 25%;&quot; /&gt;</p></li><li><p>Const 修饰类的话</p><ul><li>就好像所有成员变量都是 const 量</li><li>构造函数仍能初始化成员变量</li><li>const 成员函数泵修改成员变量</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span class="token comment">// 不能修改成员变量</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">&amp;</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>  <span class="token comment">// 返回一个 const &amp; 引用</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">&amp;</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token comment">// 不能修改成员变量，返回一个 const &amp; 引用</span></pre></td></tr></table></figure></li></ul><h3 id="35-c-pointer"><a class="anchor" href="#35-c-pointer">#</a> 3.5 C++ Pointer</h3><h4 id="nullptr"><a class="anchor" href="#nullptr">#</a> Nullptr</h4><p>主要是用来解决之前二义性的问题，如 code</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    cout<span class="token operator">&lt;&lt;</span> a <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">void</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">assert</span><span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">F</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用第一个</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">F</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第二个</span></pre></td></tr></table></figure><h4 id="智能指针"><a class="anchor" href="#智能指针">#</a> 智能指针</h4><ul><li><p>unique_ptr:</p><ul><li>内存资源的所有权不需要共享（它没有拷贝构造函数）</li><li>它可以转让给另一个 unique_ptr（存在 move 构造函数）。</li></ul></li><li><p>shared_ptr:</p><ul><li>内存资源需要共享。</li><li>一个 shared_ptr 只有在已经没有任何其它 shared_ptr 指向其原本所指向对象时，才会销毁该对象。</li></ul></li><li><p>weak_ptr:</p><ul><li>持有被 shared_ptr 所管理对象的引用，但是不会改变引用计数值。</li><li>weak_ptr 并不拥有它所指向的对象，因此不影响该对象的<strong>销毁与否</strong>。</li><li>必须调用 lock () 来获得被引用对象的 shared_ptr，通过它才能访问这个对象。</li></ul></li></ul><figure class="highlight cpp"><figcaption data-lang="C++"><span>unique_ptr</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> p2 <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// transfer ownership</span></pre></td></tr><tr><td data-num="7"></td><td><pre> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">foo</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//get () 函数将返回 nullptr</span></pre></td></tr><tr><td data-num="10"></td><td><pre> </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">(</span><span class="token operator">*</span>p2<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">foo</span><span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 不知直接赋值，而是需要用 move ();</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"><span>share_ptr</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>    shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> a<span class="token punctuation">;</span> <span class="token comment">// a is empty </span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>        shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">b</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span> <span class="token number">10</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allocate resource </span></pre></td></tr><tr><td data-num="5"></td><td><pre>        a <span class="token operator">=</span> b<span class="token punctuation">;</span> <span class="token comment">// reference counter: 2 </span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>            shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> c <span class="token operator">=</span> a<span class="token punctuation">;</span> <span class="token comment">// reference counter: 3 </span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token comment">// c dead, reference counter: 2 </span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token comment">// b dead, reference counter: 1 </span></pre></td></tr><tr><td data-num="11"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>a <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   <span class="token comment">// *a = 100</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token comment">// release resource</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">auto</span> p2 <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//p1 和 p2 作用等价。make_shared&lt;T > 是一个非成员函数，使用它的好处是可以一次性分配共享对象和智能指针自身的内存。而显示地使用 shared_ptr 构造函数来构造则至少需要两次内存分配</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/* p1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  1. 执行申请 数据体 (StructA) 的内存申请</pre></td></tr><tr><td data-num="20"></td><td><pre>        new StructA</pre></td></tr><tr><td data-num="21"></td><td><pre>  2. 执行控制块的内存申请</pre></td></tr><tr><td data-num="22"></td><td><pre>        shared_ptr A</pre></td></tr><tr><td data-num="23"></td><td><pre>*/</pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">/* p2</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  数据体 和 控制块的 内存一块申请  new StructA &amp; shared_ptr A</pre></td></tr><tr><td data-num="27"></td><td><pre>*/</pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"><span>weak_ptr</span></figcaption><table><tr><td data-num="1"></td><td><pre>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> w1<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">a</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>    w1 <span class="token operator">=</span> a<span class="token punctuation">;</span>  <span class="token comment">//w1 基本上也不能用來做資料的存取，主要只能用來監控 a 目前的狀況</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span>  <span class="token comment">//a 的资源会被释放</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">auto</span> p <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> wp <span class="token operator">=</span> p<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">auto</span> sp <span class="token operator">=</span> wp<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必须调用 lock () 来获得被引用对象的 shared_ptr，通过它才能访问这个对象</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>sp <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> </pre></td></tr><tr><td data-num="14"></td><td><pre>p<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>wp<span class="token punctuation">.</span><span class="token function">expired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"expired"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="环形引用"><a class="anchor" href="#环形引用">#</a> 环形引用</h4><p>对象 A 持有对象 B 的强引用，对象 B 持有对象 A 的强应用，最终导致 A 和 B 都无法释放</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_StructA</span> StructA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_StructB</span> StructB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_StructA</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>StructB<span class="token operator">></span> pStructB<span class="token punctuation">;</span>  <span class="token comment">//A 有 B 的强引用</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">//….</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_StructB</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>StructA<span class="token operator">></span> pStructA<span class="token punctuation">;</span> <span class="token comment">//B 有 A 的强引用</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">//….</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>StructA<span class="token operator">></span> pA <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>StructA<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre>    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>StructB<span class="token operator">></span> <span class="token function">pB</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">StructB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    pA<span class="token operator">-></span>pStructB <span class="token operator">=</span> pB<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>    pB<span class="token operator">-></span>pStructA <span class="token operator">=</span> pA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token comment">// 超出作用域之后，A, B 资源都无法释放</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// 解决方案</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">// 解决方法，其中一方使用弱引用</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_StructA</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>StructB<span class="token operator">></span> pStructB<span class="token punctuation">;</span>  <span class="token comment">//A 有 B 的强引用</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">//….</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_StructB</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span>StructA<span class="token operator">></span> pStructA<span class="token punctuation">;</span> <span class="token comment">//B 有 A 的弱引用</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// ….</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="36-多线程"><a class="anchor" href="#36-多线程">#</a> 3.6 多线程</h3><h4 id="多任务多内存模型"><a class="anchor" href="#多任务多内存模型">#</a> 多任务多内存模型</h4><table><thead><tr><th><strong>枚举值</strong></th><th><strong>规则</strong></th><th><strong>Type</strong></th></tr></thead><tbody><tr><td>memory_order_relaxed</td><td>不对执行顺序做任何保证</td><td>存储 (store)/ 读取 (load)</td></tr><tr><td>memory_order_consume</td><td>本线程所有后续有关本操作的必须在本操作完成后执行</td><td>读取 (load)</td></tr><tr><td>memory_order_acquire</td><td>本线程所有后续的读操作必须在本条操作完成才能执行</td><td>读取 (load)</td></tr><tr><td>memory_order_release</td><td>本线程所有之前的写操作完成后才执行本操作</td><td>存储 (store)</td></tr><tr><td>memory_order_acq_rel</td><td>同时包含 acquire 和 release</td><td>存储 (store)/ 读取 (load)</td></tr><tr><td>memory_order_seq_cst</td><td>全部顺序执行</td><td>存储 (store)/ 读取 (load)</td></tr></tbody></table><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">thread_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    a <span class="token operator">=</span> t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">int</span> thread_2<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">//a 值多线程操作不一定为 1</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="15"></td><td><pre>1. Loadi reg3,1</pre></td></tr><tr><td data-num="16"></td><td><pre>2. Move reg4,reg3</pre></td></tr><tr><td data-num="17"></td><td><pre>3. Store reg4,a</pre></td></tr><tr><td data-num="18"></td><td><pre>4. Loadi reg5,2</pre></td></tr><tr><td data-num="19"></td><td><pre>5. Store reg5,b</pre></td></tr><tr><td data-num="20"></td><td><pre>CPU 执行顺序可以为</pre></td></tr><tr><td data-num="21"></td><td><pre>1->2->3->4->5</pre></td></tr><tr><td data-num="22"></td><td><pre>也可能为</pre></td></tr><tr><td data-num="23"></td><td><pre>1->4->2->5->3</pre></td></tr><tr><td data-num="24"></td><td><pre>(1,2,3) 与 (4,5) 使用了不同指令和 Reg</pre></td></tr><tr><td data-num="25"></td><td><pre>*/</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">int</span> <span class="token function">thread_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    a<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 没有要求</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    b<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 写操作完成后才执行本操作  </span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">int</span> <span class="token function">thread_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>memory_order_acquire<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> a<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>    </pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">//a 值永远为 1</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="原子操作"><a class="anchor" href="#原子操作">#</a> 原子操作</h4><p>多个线程访问同一个全局资源的时候，能够确保所有其他的线程都不在同一时间内访问相同的资源</p><p>–std::atomic_flag</p><ul><li><p>操作</p><ul><li><strong>test_and_set</strong>, 如果 atomic_flag 对象被设置，则返回 true; 如果 atomic_flag 对象未被设置，则设置之，返回 false</li><li><strong>clear</strong>. 清除 atomic_flag 对象</li></ul></li><li><p>使用 atomic_flag 可实现 mutex.</p></li></ul><p>–std::atomic</p><ul><li>对 int, char, bool 等数据结构进行原子性封装</li><li>利用 std::atomic 可实现数据结构的无锁设计</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sstream></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>std<span class="token operator">::</span>atomic_flag lock <span class="token operator">=</span> ATOMIC_FLAG_INIT<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>std<span class="token operator">::</span>stringstream stream<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">void</span> <span class="token function">append_numer</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">test_and_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    stream <span class="token operator">&lt;&lt;</span> <span class="token string">"thread#"</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    lock<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>thread<span class="token operator">></span> ths<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        ths<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">thread</span><span class="token punctuation">(</span>append_numer<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        ths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> stream<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">ready</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>std<span class="token operator">::</span>atomic_flag winner <span class="token operator">=</span> ATOMIC_FLAG_INIT<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">void</span> <span class="token function">count</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ready<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>winner<span class="token punctuation">.</span><span class="token function">test_and_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"winner: "</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>thread<span class="token operator">></span> ths<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        ths<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">thread</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        ths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="thread_local"><a class="anchor" href="#thread_local">#</a> Thread_local</h4><p>thread_local 关键字修饰的变量具有线程周期 (thread duration)</p><p>变量或对象在线程开始的时候被生成 (allocated)，在线程结束的时候被销毁 (deallocated)</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">thread_local</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>  <span class="token comment">//A thread-local variable at namespace scope</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">X</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">thread_local</span> std<span class="token operator">::</span>string s<span class="token punctuation">;</span> <span class="token comment">//A thread-local static class data member</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">thread_local</span> std<span class="token operator">::</span>string X<span class="token operator">::</span>s<span class="token punctuation">;</span>  <span class="token comment">//The definition of X::s is required</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">thread_local</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> v<span class="token punctuation">;</span>  <span class="token comment">//A thread-local local variable</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>std_thread</code></p><ul><li><p><code>std::thread::join()</code> 等待子线程执行完之后，主线程才可以继续执行下去，此时主线程会释放掉执行完后的子线程资源</p></li><li><p><code>std::thread::detach()</code> 将子线程从主线程里分离，子线程执行完成后会自己释放掉资源。分离后的线程，主线程将对它没有控制权了</p></li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">HelloWorld</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span>   </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 创建一个分支线程，回调到 myThread 函数里</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    std<span class="token operator">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>HelloWorld<span class="token operator">::</span>myThread<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">CCLOG</span><span class="token punctuation">(</span>“in major thread”<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在主线程</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">HelloWorld</span><span class="token operator">::</span><span class="token function">myThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">CCLOG</span><span class="token punctuation">(</span><span class="token string">"in my thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="16"></td><td><pre>运行结果：</pre></td></tr><tr><td data-num="17"></td><td><pre>in my thread</pre></td></tr><tr><td data-num="18"></td><td><pre>in major thread</pre></td></tr><tr><td data-num="19"></td><td><pre>*/</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">// --- //</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">HelloWorld</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#123;</span>   </pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 创建一个分支线程，回调到 myThread 函数里</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    std<span class="token operator">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>HelloWorld<span class="token operator">::</span>myThread<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="28"></td><td><pre>    t1<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">CCLOG</span><span class="token punctuation">(</span>“in major thread”<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在主线程</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">HelloWorld</span><span class="token operator">::</span><span class="token function">myThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">CCLOG</span><span class="token punctuation">(</span><span class="token string">"in my thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="39"></td><td><pre>in major thread</pre></td></tr><tr><td data-num="40"></td><td><pre>in my thread </pre></td></tr><tr><td data-num="41"></td><td><pre>或</pre></td></tr><tr><td data-num="42"></td><td><pre>in my thread </pre></td></tr><tr><td data-num="43"></td><td><pre>in major thread</pre></td></tr><tr><td data-num="44"></td><td><pre>*/</pre></td></tr></table></figure><div class="tags"><a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C++</a> <a href="/tags/Make/" rel="tag"><i class="ic i-tag"></i> Make</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-04-19 00:32:04" itemprop="dateModified" datetime="2021-04-19T00:32:04+08:00">2021-04-19</time></span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80MzY4Ni8yMDIyNg=="><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Junwide Xiao 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Junwide Xiao 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Junwide Xiao <i class="ic i-at"><em>@</em></i>精神小伙</li><li class="link"><strong>本文链接：</strong> <a href="https://junwide.github.io/Program/SWDevelopmentSkill/" title="SW Development Skill">https://junwide.github.io/Program/SWDevelopmentSkill/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Other/%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%8D%9A%E5%AE%A2%E5%88%9B%E4%BD%9C%E6%8C%87%E5%8D%97/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;junwide&#x2F;blog&#x2F;raw&#x2F;master&#x2F;20210418104528.jpg" title="协作式博客创作指南"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 杂项</span><h3>协作式博客创作指南</h3></a></div><div class="item right"><a href="/Linux-Basic/Linux%20Kernel%20Build/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;junwide&#x2F;blog&#x2F;raw&#x2F;master&#x2F;20210418104554.jpg" title="Linux Kernel Build"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Linux基础</span><h3>Linux Kernel Build</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sw-development-skill"><span class="toc-number">1.</span> <span class="toc-text">SW Development Skill</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-makefile"><span class="toc-number">1.1.</span> <span class="toc-text">1. Makefile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-makefile%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 Makefile 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-makefile%E4%B8%AD%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 Makefile 中的概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-makefile%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 Makefile 的语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E6%A0%91"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 依赖关系树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5 执行过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-%E9%9A%90%E5%90%AB%E8%A7%84%E5%88%99"><span class="toc-number">1.1.6.</span> <span class="toc-text">1.6 隐含规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.7.</span> <span class="toc-text">1.7 代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-c-advance"><span class="toc-number">1.2.</span> <span class="toc-text">2. C Advance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 可执行文件结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 进程的结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-%E5%AE%8F%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 宏函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-practical"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 Practical</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-c-advance"><span class="toc-number">1.3.</span> <span class="toc-text">3. C++ Advance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E5%87%BD%E6%95%B0%E7%9B%B8%E5%85%B3"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 函数相关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E7%B1%BB"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">类的定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">构造 &#x2F; 析构函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 运算符重载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-this%E5%92%8C%E6%88%90%E5%91%98%E4%BF%AE%E9%A5%B0"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 this 和成员修饰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#35-c-pointer"><span class="toc-number">1.3.5.</span> <span class="toc-text">3.5 C++ Pointer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nullptr"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">Nullptr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">智能指针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%BD%A2%E5%BC%95%E7%94%A8"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">环形引用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#36-%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.3.6.</span> <span class="toc-text">3.6 多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E4%BB%BB%E5%8A%A1%E5%A4%9A%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">多任务多内存模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">原子操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#thread_local"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">Thread_local</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/Program/SWDevelopmentSkill/" rel="bookmark" title="SW Development Skill">SW Development Skill</a></li><li><a href="/Program/math02/" rel="bookmark" title="Math in anywhere |  Vector">Math in anywhere | Vector</a></li><li><a href="/Program/math01/" rel="bookmark" title="Math in anywhere | Funciton">Math in anywhere | Funciton</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Junwide Xiao" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Junwide Xiao</p><div class="description" itemprop="description">生活与技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">25</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">24</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2p1bndpZGU=" title="https:&#x2F;&#x2F;github.com&#x2F;junwide"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29t" title="https:&#x2F;&#x2F;www.zhihu.com"><i class="ic i-zhihu"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20=" title="https:&#x2F;&#x2F;weibo.com"><i class="ic i-weibo"></i></span> <a href="https://junwide.github.io/about" title="https:&#x2F;&#x2F;junwide.github.io&#x2F;about" class="item about"><i class="ic i-address-card"></i></a> <span class="exturl item email" data-url="bWFpbHRvOmp1bndpZGVAb3V0bG9vay5jb20=" title="mailto:junwide@outlook.com"><i class="ic i-envelope"></i></span> <span class="exturl item youtube" data-url="aHR0cHM6Ly95b3V0dWJlLmNvbQ==" title="https:&#x2F;&#x2F;youtube.com"><i class="ic i-youtube"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/Other/%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%8D%9A%E5%AE%A2%E5%88%9B%E4%BD%9C%E6%8C%87%E5%8D%97/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/Linux-Basic/Linux%20Kernel%20Build/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/Linux%20%E8%A7%A3%E5%AF%86%E2%80%94CPU%E5%88%A9%E7%94%A8%E7%8E%87/" title="Linux 解密—CPU利用率">Linux 解密—CPU利用率</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/theme-shoka-doc/" title="分类于 博客">博客</a></div><span><a href="/theme-shoka-doc/dependents/" title="Step.1 依赖插件">Step.1 依赖插件</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/theme-shoka-doc/" title="分类于 博客">博客</a></div><span><a href="/theme-shoka-doc/display/" title="Step.3 界面显示">Step.3 界面显示</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Latex%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F%E8%A1%A8%E8%BE%BE%E4%BB%A5%E5%8F%8A%E5%85%B6%E4%BB%96MD%E5%BD%A2%E5%BC%8F/" title="Latex数学公式表达以及其他MD形式">Latex数学公式表达以及其他MD形式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/Kernel%20Module%20%E2%80%94%20Simple%20Example/" title="Kernel Module — Simple Example">Kernel Module — Simple Example</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/UPBoard%20%E4%BC%98%E5%8C%96%E4%BF%AE%E5%A4%8D%E6%8C%87%E5%8D%97/" title="UPBoard 优化修复指南">UPBoard 优化修复指南</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/devnull%20%E2%80%94%E2%80%94The%20Bit%20Bucket/" title="&#x2F;dev&#x2F;null ——The Bit Bucket 的故事">/dev/null ——The Bit Bucket 的故事</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/other/" title="分类于 杂项">杂项</a></div><span><a href="/Other/Tech%20New%20Innovation/" title="Tech New Innovation">Tech New Innovation</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-basic/" title="分类于 Linux基础">Linux基础</a></div><span><a href="/Linux-Basic/Linux%20Kernel%20Build/" title="Linux Kernel Build">Linux Kernel Build</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/normal-Skill/" title="分类于 其他技巧">其他技巧</a></div><span><a href="/normal-Skill/Git_%E7%9A%84%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8/" title="Git 的日常使用">Git 的日常使用</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Junwide Xiao @ Brain Home</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">138k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:11</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Program/SWDevelopmentSkill/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>